# 高级配置和备份功能指南

## 📋 概述

本文档说明了微舆系统的高级配置功能、WebDAV云备份功能以及配置的导入导出功能。

## ✅ 配置统一总结

### 1. MindSpider 配置已完全整合

**之前的情况**：
- MindSpider 有独立的 `MindSpider/config.py` 文件
- 需要单独配置数据库和API密钥
- 容易导致配置不一致

**现在的情况**：
- ✅ MindSpider 自动从主配置文件导入所有配置
- ✅ 数据库配置统一（爬虫和舆情使用同一个数据库）
- ✅ DeepSeek API 自动继承 Query Engine 的配置
- ✅ 可通过网页界面单独配置 MindSpider 的 DeepSeek API

**自动继承逻辑**：
```
MindSpider/config.py
   ↓ 导入
主配置文件 (config.py)
   ├─ DB_HOST, DB_PORT, DB_USER, DB_PASSWORD, DB_NAME, DB_CHARSET
   └─ DEEPSEEK_API_KEY (如果未设置，则继承 QUERY_ENGINE_API_KEY)
```

### 2. 数据库配置已统一

**单一数据库配置**：
```python
# config.py
DB_HOST = "localhost"
DB_PORT = 3306
DB_USER = "weiyu_user"
DB_PASSWORD = "your_password"
DB_NAME = "weiyu_db"
DB_CHARSET = "utf8mb4"
```

**使用范围**：
- ✅ InsightEngine - 读取舆情数据
- ✅ MindSpider 爬虫 - 写入爬取的数据
- ✅ 所有数据库工具

**优势**：
- 只需配置一次
- 爬虫数据和舆情分析数据在同一个库
- 方便数据管理和备份

### 3. 网页配置已完整实现

**可通过网页配置的项目**：

#### 基础配置
- ✅ 6个引擎的 LLM 配置（API Key, Base URL, Model Name）
- ✅ 2个搜索工具（Tavily, Bocha）
- ✅ MindSpider DeepSeek API

#### 高级参数配置 ⚙️
- ✅ Query Engine（反思轮次、搜索结果数、内容长度）
- ✅ Media Engine（反思轮次、段落数）
- ✅ Insight Engine（反思轮次、搜索限制、评论获取限制）

#### 情感分析配置 💬
- ✅ 模型类型（multilingual/bert/qwen）
- ✅ 置信度阈值
- ✅ 批处理大小
- ✅ 最大序列长度

#### WebDAV 备份配置 ☁️
- ✅ WebDAV 服务器地址
- ✅ 用户名和密码

**注意**：数据库配置（DB_*）不支持网页配置，必须在 `config.py` 文件或环境变量中配置。

## 🎯 高级配置详解

### Query Engine 高级参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 反思轮次 | 2 | 1-10 | Query Agent 内部思考和优化的轮次。增加可提升质量，但耗时更长 |
| 最大搜索结果数 | 20 | 5-50 | 从搜索API获取的最大结果数量 |
| 最大内容长度 | 20000 | 1000-100000 | 单次处理的最大文本字符数 |
| 搜索超时 | 240秒 | - | 搜索操作的超时时间 |

**使用建议**：
- 快速分析：反思轮次=1，搜索结果=10
- 平衡质量：反思轮次=2，搜索结果=20（默认）
- 深度分析：反思轮次=3-5，搜索结果=30-50

### Media Engine 高级参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 反思轮次 | 2 | 1-10 | 多模态分析的优化轮次 |
| 最大段落数 | 5 | 1-20 | 生成报告的最大段落数量 |
| 最大内容长度 | 20000 | 1000-100000 | 处理的最大内容长度 |

**使用建议**：
- 适合图文混合内容分析
- 增加段落数可获得更详细的报告

### Insight Engine 高级参数

| 参数 | 默认值 | 范围 | 说明 |
|------|--------|------|------|
| 反思轮次 | 3 | 1-10 | 数据库挖掘的优化轮次 |
| 热点内容搜索限制 | 100 | 10-500 | 从数据库获取热点内容的最大数量 |
| 评论获取限制 | 500 | 50-2000 | 每个话题获取的最大评论数 |
| 全局话题搜索限制 | 50 | - | 全局话题搜索限制（每表） |
| 按日期搜索限制 | 100 | - | 按日期话题搜索限制（每表） |
| 平台话题搜索限制 | 200 | - | 平台话题搜索限制 |
| 传给LLM的最大结果数 | 50 | - | 传给LLM的最大结果数 |

**使用建议**：
- 数据量大时：降低搜索限制以提升速度
- 需要全面分析：提高评论获取限制
- 超长上下文模型：可增加传给LLM的结果数

### 情感分析配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 模型类型 | multilingual | multilingual（推荐）、bert、qwen |
| 置信度阈值 | 0.8 | 0.0-1.0，用于过滤低置信度结果 |
| 批处理大小 | 32 | 批量处理的文本数量，影响速度和内存占用 |
| 最大序列长度 | 512 | 单个文本的最大token数 |

**模型类型说明**：
- **multilingual**：支持22种语言，推荐用于多语言环境
- **bert**：中文BERT模型，适合纯中文场景
- **qwen**：Qwen情感模型，性能较好

## ☁️ WebDAV 备份功能

### 支持的WebDAV服务

- ✅ **坚果云** - 推荐（国内稳定）
- ✅ **Nextcloud** - 开源自建
- ✅ **Seafile** - 开源自建
- ✅ **Synology NAS** - 群晖NAS
- ✅ 其他支持WebDAV协议的服务

### 坚果云配置示例

1. **登录坚果云**：https://www.jianguoyun.com/

2. **创建应用密码**：
   - 进入「账户信息」→「安全选项」→「添加应用密码」
   - 应用名称：微舆配置备份
   - 记录生成的应用密码

3. **获取WebDAV地址**：
   ```
   https://dav.jianguoyun.com/dav/
   ```

4. **在微舆中配置**：
   - WebDAV服务器地址：`https://dav.jianguoyun.com/dav/`
   - 用户名：你的坚果云账号（邮箱）
   - 密码：上一步创建的应用密码

5. **备份文件夹**：
   - 配置会自动保存到坚果云的 `BettaFish` 文件夹中
   - 文件名格式：`weiyu_config_20250110_143022.json`

### Nextcloud配置示例

```
WebDAV地址：https://your-nextcloud.com/remote.php/dav/files/username/
用户名：your_username
密码：your_password 或 应用专用密码
```

### 备份功能说明

**自动创建文件夹**：
- 首次备份时自动在WebDAV根目录创建 `BettaFish` 文件夹
- 所有配置备份都保存在此文件夹中

**备份文件格式**：
```json
{
  "version": "1.0",
  "backup_time": "2025-01-10T14:30:22.123Z",
  "config": {
    "engines": { ... },
    "search_tools": { ... },
    "mindspider": { ... },
    "advanced": { ... },
    "sentiment": { ... },
    "webdav": { ... }
  }
}
```

**恢复策略**：
- 自动选择最新的备份文件
- 恢复前会显示确认对话框
- 恢复后自动刷新页面以应用新配置

## 💾 导出/导入功能

### 导出配置到本地

**操作步骤**：
1. 点击配置界面的「💾 导出到本地」按钮
2. 浏览器自动下载配置文件
3. 文件名格式：`weiyu_config_2025-01-10T14-30-22.json`

**用途**：
- 备份当前配置
- 迁移到其他浏览器/电脑
- 分享配置给团队成员
- 版本控制

### 从本地导入配置

**操作步骤**：
1. 点击配置界面的「📂 从本地导入」按钮
2. 选择之前导出的JSON配置文件
3. 确认导入
4. 页面自动刷新并应用新配置

**注意事项**：
- 导入会覆盖当前所有配置
- 建议导入前先导出当前配置作为备份
- 导入的文件必须是有效的JSON格式

### 配置文件兼容性

配置文件格式向后兼容，版本信息在文件中标识：

```json
{
  "version": "1.0",  // 配置格式版本
  "backup_time": "...",  // 备份时间
  "config": { ... }  // 实际配置内容
}
```

## 🔄 配置应用机制

### 热更新

配置修改后立即生效，无需重启服务：

```
用户修改配置
   ↓
保存到 localStorage
   ↓
发送到后端 API
   ↓
更新环境变量
   ↓
重新初始化相关组件
   ↓
配置生效 ✅
```

**热更新的组件**：
- ✅ ReportEngine
- ✅ ForumHost
- ✅ 所有LLM API配置
- ✅ 搜索工具配置
- ✅ 高级参数

**需要重启的配置**：
- ❌ 数据库配置（DB_*）

### 配置持久化

**存储位置**：
1. **浏览器 localStorage**：主要存储，自动加载
2. **WebDAV 云端**：可选备份，手动同步
3. **本地文件**：导出备份，手动加载

**同步策略**：
```
启动时：从 localStorage 自动加载
修改时：保存到 localStorage + 发送到后端
备份时：手动上传到 WebDAV 或导出本地
恢复时：从 WebDAV 或本地文件读取 → 覆盖 localStorage
```

## 🚀 使用场景

### 场景1：团队协作

**问题**：团队成员需要使用相同的配置

**解决方案**：
1. 团队管理员配置好系统
2. 导出配置文件
3. 分享配置文件给团队成员
4. 成员导入配置文件

### 场景2：多环境部署

**问题**：开发、测试、生产环境配置不同

**解决方案**：
1. 分别配置三套环境
2. 导出为不同的配置文件
   - `weiyu_config_dev.json`
   - `weiyu_config_test.json`
   - `weiyu_config_prod.json`
3. 根据需要快速切换

### 场景3：配置备份和灾难恢复

**问题**：配置丢失或损坏

**解决方案**：
1. **定期备份到WebDAV**：
   - 修改重要配置后手动备份
   - 自动保存在云端

2. **本地导出备份**：
   - 重要配置变更后导出
   - 保存到本地或Git仓库

3. **恢复配置**：
   - 从WebDAV恢复最新配置
   - 或从本地文件导入

### 场景4：性能调优

**问题**：分析速度慢或质量不够

**解决方案**：
1. 进入高级参数配置
2. 根据场景调整参数：
   - **快速分析**：降低反思轮次和搜索结果数
   - **深度分析**：增加反思轮次和数据获取限制
   - **批量处理**：调整批处理大小
3. 保存配置并测试效果
4. 找到最佳参数后备份配置

## 📊 配置统计

### 可配置项总数

| 类别 | 配置项数量 |
|------|-----------|
| 引擎 LLM | 6 × 3 = 18 项 |
| 搜索工具 | 2 项 |
| MindSpider | 1 项 |
| Query Engine 高级参数 | 4 项 |
| Media Engine 高级参数 | 5 项 |
| Insight Engine 高级参数 | 10 项 |
| 情感分析 | 4 项 |
| WebDAV | 3 项 |
| **总计** | **47 项** |

### 配置层级

```
根配置
├── engines (18项)
│   ├── insight (API Key, Base URL, Model Name)
│   ├── media (API Key, Base URL, Model Name)
│   ├── query (API Key, Base URL, Model Name)
│   ├── report (API Key, Base URL, Model Name)
│   ├── forum (API Key, Base URL, Model Name)
│   └── keyword_optimizer (API Key, Base URL, Model Name)
├── search_tools (2项)
│   ├── tavily_api_key
│   └── bocha_api_key
├── mindspider (1项)
│   └── deepseek_api_key
├── advanced (19项)
│   ├── query (4项)
│   ├── media (5项)
│   └── insight (10项)
├── sentiment (4项)
└── webdav (3项)
```

## 🔒 安全性

### API密钥保护

1. **存储安全**：
   - 保存在浏览器 localStorage（客户端本地）
   - WebDAV 传输使用 HTTPS 加密
   - 不会保存在服务器日志中

2. **传输安全**：
   - 使用 HTTPS 协议传输
   - WebDAV 支持 SSL/TLS 加密

3. **访问控制**：
   - 配置界面需要访问主页面权限
   - WebDAV 需要用户名密码认证

### 建议的安全实践

1. ✅ 使用HTTPS访问微舆系统
2. ✅ 定期更换API密钥
3. ✅ 使用WebDAV应用专用密码（而非主密码）
4. ✅ 不要将配置文件上传到公开位置
5. ✅ 团队分享时使用安全的传输方式

## 🛠️ 故障排除

### 配置无法保存

**可能原因**：
- 浏览器禁用了 localStorage
- 浏览器处于无痕/隐私模式

**解决方案**：
1. 检查浏览器设置，启用本地存储
2. 退出无痕模式
3. 尝试其他浏览器

### WebDAV连接失败

**可能原因**：
- WebDAV地址错误
- 用户名或密码错误
- 网络连接问题
- 服务器不支持WebDAV

**解决方案**：
1. 检查WebDAV地址是否正确
2. 确认用户名和密码（坚果云需要使用应用密码）
3. 测试网络连接
4. 查看浏览器控制台的详细错误信息

### 配置导入失败

**可能原因**：
- 文件格式错误
- 文件损坏
- 版本不兼容

**解决方案**：
1. 检查文件是否为有效的JSON格式
2. 尝试用文本编辑器打开文件查看内容
3. 确认文件包含必需的字段（version, config）
4. 重新导出配置文件

### 高级参数不生效

**可能原因**：
- 配置未正确保存
- 引擎未重启
- 参数值超出有效范围

**解决方案**：
1. 确认点击了「保存配置」按钮
2. 查看保存成功的提示信息
3. 检查参数值是否在有效范围内
4. 尝试刷新页面重新加载配置

## 📝 更新日志

### v1.0.0 (2025-01-10)

**新增功能**：
- ✅ 高级参数配置（Query/Media/Insight Engine）
- ✅ 情感分析配置
- ✅ WebDAV 云备份功能
- ✅ 配置导出/导入功能
- ✅ MindSpider 配置统一
- ✅ 数据库配置统一

**改进**：
- ✅ 配置界面重新设计
- ✅ 配置项分类更清晰
- ✅ 添加配置说明和建议值
- ✅ 恢复推荐配置功能增强

**修复**：
- ✅ 配置保存和加载的兼容性问题
- ✅ MindSpider 配置导入逻辑

## 🎯 下一步计划

- [ ] 配置版本管理（多版本配置切换）
- [ ] 配置比较功能（对比不同配置）
- [ ] 配置模板（预设常用场景配置）
- [ ] 自动备份（定时备份到WebDAV）
- [ ] 配置历史记录（回退到历史配置）
- [ ] 配置分享（生成分享链接）

## 📞 获取帮助

如果在使用过程中遇到问题：

1. 查看本文档的「故障排除」部分
2. 查看主要文档：
   - `CONFIGURATION_GUIDE.md` - 完整配置指南
   - `CONFIGURATION_UNIFICATION.md` - 配置统一说明
   - `WEB_CONFIG_GUIDE.md` - 网页配置使用指南
3. 提交 Issue 或联系技术支持

---

**文档版本**: v1.0.0  
**最后更新**: 2025-01-10  
**维护者**: 微舆开发团队
