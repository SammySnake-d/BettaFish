<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®èˆ†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #ffffff;
            color: #000000;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            height: 100vh; /* å›ºå®šé«˜åº¦ä¸ºè§†å£é«˜åº¦ */
            display: flex;
            flex-direction: column;
            border: 2px solid #000000;
            overflow: hidden; /* é˜²æ­¢æ•´ä½“æ»šåŠ¨ */
        }

        /* æœç´¢æ¡†åŒºåŸŸ */
        .search-section {
            border-bottom: 2px solid #000000;
            padding: 20px;
            background-color: #ffffff;
        }

        .search-title {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            letter-spacing: 1px;
        }

        .search-box {
            display: flex;
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #000000;
        }

        .search-input {
            flex: 1;
            padding: 15px;
            border: none;
            outline: none;
            font-size: 16px;
            background-color: #ffffff;
        }

        .search-button {
            padding: 15px 30px;
            border: none;
            border-left: 2px solid #000000;
            background-color: #000000;
            color: #ffffff;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .search-button:hover {
            background-color: #333333;
        }

        .search-button:disabled {
            background-color: #666666;
            cursor: not-allowed;
        }

        .upload-button {
            padding: 15px 20px;
            border: none;
            border-left: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .upload-button:hover {
            background-color: #f0f0f0;
        }

        .upload-button input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-status {
            font-size: 12px;
            margin-top: 10px;
            text-align: center;
            color: #666666;
        }

        .upload-status.success {
            color: #4a6741;
        }

        .upload-status.error {
            color: #8b4513;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            height: calc(100vh - 140px);
            min-height: 0; /* å…è®¸å­å…ƒç´ ç¼©å° */
        }

        /* åµŒå…¥é¡µé¢åŒºåŸŸ */
        .embedded-section {
            flex: 1.8; /* ç¨å¾®ç¼©å°å·¦ä¾§åŒºåŸŸ */
            border-right: 2px solid #000000;
            background-color: #ffffff;
            position: relative;
        }

        .embedded-header {
            padding: 15px;
            border-bottom: 2px solid #000000;
            background-color: #ffffff;
            font-weight: bold;
            text-align: center;
        }

        .embedded-content {
            height: calc(100% - 60px);
            position: relative;
            overflow: hidden;
        }

        /* æ§åˆ¶å°è¾“å‡ºåŒºåŸŸ */
        .console-section {
            flex: 1.2; /* ç¨å¾®æ‰©å¤§å³ä¾§åŒºåŸŸ */
            display: flex;
            flex-direction: column;
            background-color: #ffffff;
            min-height: 0; /* å…è®¸å­å…ƒç´ ç¼©å° */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
        }

        /* åº”ç”¨åˆ‡æ¢æŒ‰é’® */
        .app-switcher {
            display: flex;
            border-bottom: 2px solid #000000;
        }

        .app-button {
            flex: 1;
            padding: 15px;
            border: none;
            border-right: 2px solid #000000;
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }

        .app-button:last-child {
            border-right: none;
        }

        .app-button.active {
            background-color: #000000;
            color: #ffffff;
        }

        .app-button:not(.active):hover {
            background-color: #f0f0f0;
        }

        .app-button.locked {
            background-color: #f5f5f5;
            color: #999999;
            cursor: not-allowed;
            position: relative;
        }

        .app-button.locked:hover {
            background-color: #f5f5f5;
        }

        .app-button.locked::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            font-size: 12px;
        }

        .app-button.locked .status-indicator {
            background-color: #cccccc;
        }

        .status-indicator {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff0000;
        }

        .status-indicator.running {
            background-color: #00ff00;
        }

        .status-indicator.starting {
            background-color: #ffff00;
        }

        /* æ§åˆ¶å°è¾“å‡º */
        .console-output {
            flex: 1;
            padding: 15px;
            background-color: #000000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            overflow-x: hidden;
            white-space: pre-wrap;
            word-break: break-all;
            min-height: 0; /* å…è®¸å†…å®¹ç¼©å° */
        }

        .console-line {
            margin-bottom: 2px;
        }

        /* çŠ¶æ€ä¿¡æ¯ */
        .status-bar {
            padding: 10px 20px;
            border-top: 2px solid #000000;
            background-color: #ffffff;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #000000;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        /* ä¸“é—¨ç”¨äºæŠ¥å‘ŠçŠ¶æ€çš„åŠ è½½æŒ‡ç¤ºå™¨ï¼Œä¸ä¼šè®©æ•´ä¸ªå®¹å™¨æ—‹è½¬ */
        .report-loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffa500;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* ä»»åŠ¡è¿›åº¦æ¡æ ·å¼ */
        .task-progress-container {
            margin: 0; /* ç§»é™¤marginï¼Œä½¿ç”¨çˆ¶å®¹å™¨çš„gapæ§åˆ¶é—´è· */
            padding: 20px;
            border: 2px solid #000000;
            background-color: #f5f5f0;
        }

        .task-progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 16px;
        }

        .task-progress-title {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .task-progress-bar {
            width: 200px;
            height: 20px;
            background-color: #e8e8e0;
            border: 1px solid #666666;
            margin-left: 20px;
            position: relative;
            overflow: hidden;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .task-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6b8a5a 0%, #8fb584 100%);
            transition: width 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            min-width: 2px; /* ç¡®ä¿å³ä½¿æ˜¯0%ä¹Ÿæœ‰ä¸€ç‚¹æ˜¾ç¤º */
        }

        .task-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000000;
            font-weight: bold;
            font-size: 12px;
            z-index: 2;
            pointer-events: none;
        }

        .task-info-line {
            display: flex;
            align-items: center;
            margin-top: 10px;
            font-size: 13px;
            padding: 8px;
            background-color: #f0f0e8;
            border: 1px solid #d0d0c0;
            border-radius: 3px;
        }

        .task-info-item {
            display: flex;
            align-items: center;
            margin-right: 30px;
        }

        .task-info-item:last-child {
            margin-right: 0;
        }

        .task-info-label {
            font-weight: bold;
            color: #666;
            margin-right: 8px;
        }

        .task-info-value {
            color: #000;
        }

        .task-status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .task-status-running {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .task-status-completed {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .task-status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .task-error-message {
            margin-top: 15px;
            padding: 10px;
            background-color: #ffe6e6;
            border-left: 4px solid #ff4444;
            border-radius: 3px;
            font-size: 13px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
                height: auto;
            }

            .embedded-section {
                border-right: none;
                border-bottom: 2px solid #000000;
                height: 400px;
            }

            .console-section {
                height: 300px;
            }
        }

        /* æ¶ˆæ¯æç¤º */
        .message {
            position: fixed;
            top: 20px;
            right: 0px;
            padding: 15px 20px;
            border: 2px solid #000000;
            background-color: #ffffff;
            color: #000000;
            font-weight: bold;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .message.show {
            transform: translateX(-5%);
        }

        .message.success {
            border-color: #00aa00;
            background-color: #f0fff0;
        }

        .message.error {
            border-color: #aa0000;
            background-color: #fff0f0;
        }

        /* Forum Engine ä¸“ç”¨æ ·å¼ */
        .forum-container {
            display: none;
            height: 100%;
            flex-direction: column;
        }

        .forum-container.active {
            display: flex;
        }

        .forum-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .forum-message {
            margin-bottom: 20px;
            min-width: 200px;
            max-width: 85%;
            padding: 15px;
            border: 2px solid #000000;
            border-radius: 0;
            word-wrap: break-word;
        }

        .forum-message.user {
            align-self: flex-end;
            background-color: #000000;
            color: #ffffff;
        }

        .forum-message.system {
            align-self: flex-start;
            background-color:rgb(182 182 182);
            color: #000000;
            border-color:rgb(62 62 62);
        }

        .forum-message.agent {
            align-self: stretch; /* å æ»¡æ•´ä¸ªå®½åº¦ */
            color: #000000;
            width: 100%; /* ç¡®ä¿å æ»¡å®½åº¦ */
            max-width: 100%; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ */
            margin: 0 0 20px 0; /* ç§»é™¤å·¦å³è¾¹è· */
        }

        /* ä¸åŒEngineçš„é¢œè‰²åŒºåˆ† */
Â  Â  Â  Â  .forum-message.agent:has(.forum-message-header:contains("Query Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #eaf1f8;
Â  Â  Â  Â  Â  Â  border-color: #608ab1;
Â  Â  Â  Â  }

        .forum-message.agent:has(.forum-message-header:contains("QUERY Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #eaf1f8;
Â  Â  Â  Â  Â  Â  border-color: #608ab1;
    Â  Â  }

Â  Â  Â  Â  .forum-message.agent:has(.forum-message-header:contains("Insight Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #f2ebf3;
Â  Â  Â  Â  Â  Â  border-color: #8e6a9f;
Â  Â  Â  Â  }

        .forum-message.agent:has(.forum-message-header:contains("INSIGHT Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #f2ebf3;
Â  Â  Â  Â  Â  Â  border-color: #8e6a9f;
Â  Â  Â  Â  }

Â  Â  Â  Â  .forum-message.agent:has(.forum-message-header:contains("Media Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #ebf2ea;
Â  Â  Â  Â  Â  Â  border-color: #6a9a6e;
Â  Â  Â  Â  }

        .forum-message.agent:has(.forum-message-header:contains("MEDIA Engine")) {
Â  Â  Â  Â  Â  Â  background-color: #ebf2ea;
Â  Â  Â  Â  Â  Â  border-color: #6a9a6e;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* å¤‡ç”¨æ–¹æ¡ˆï¼šé€šè¿‡JavaScriptæ·»åŠ çš„ç±» */
Â  Â  Â  Â  .forum-message.query-engine {
Â  Â  Â  Â  Â  Â  background-color: #eaf1f8;
Â  Â  Â  Â  Â  Â  border-color: #608ab1;
Â  Â  Â  Â  }

Â  Â  Â  Â  .forum-message.insight-engine {
Â  Â  Â  Â  Â  Â  background-color: #f2ebf3;
Â  Â  Â  Â  Â  Â  border-color: #8e6a9f;
Â  Â  Â  Â  }

Â  Â  Â  Â  .forum-message.media-engine {
Â  Â  Â  Â  Â  Â  background-color: #ebf2ea;
Â  Â  Â  Â  Â  Â  border-color: #6a9a6e;
Â  Â  Â  Â  }

        .forum-message.agent.QUERY {
            background-color: #eaf1f8;
            border-color: #608ab1;
        }

        .forum-message.agent.query-engine {
            background-color: #eaf1f8;
            border-color: #608ab1;
        }

Â  Â  Â  Â  .forum-message.agent.MEDIA {
Â  Â  Â  Â  Â  Â  background-color: #ebf2ea;
Â  Â  Â  Â  Â  Â  border-color: #6a9a6e;
Â  Â  Â  Â  }

        .forum-message.agent.media-engine {
            background-color: #ebf2ea;
            border-color: #6a9a6e;
        }

        .forum-message.agent.INSIGHT {
            background-color: #f2ebf3;
            border-color: #8e6a9f;
        }

        .forum-message.agent.insight-engine {
            background-color: #f2ebf3;
            border-color: #8e6a9f;
        }
        
        /* HOSTä¸»æŒäººæ ·å¼ */
        .forum-message.host {
            align-self: stretch;
            background-color: #fff8dc;  /* æµ…é»„è‰²èƒŒæ™¯ */
            border-color: #daa520;  /* é‡‘è‰²è¾¹æ¡† */
            color: #000000;
            width: 100%;
            max-width: 100%;
            margin: 0 0 20px 0;
            font-style: italic;  /* æ–œä½“å­—ä½“æ˜¾ç¤ºä¸»æŒäººå‘è¨€ */
        }

        .forum-message-header {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
            opacity: 0.8;
        }

        .forum-message-content {
            line-height: 1.4;
            word-wrap: break-word;
        }

        .forum-timestamp {
            font-size: 10px;
            opacity: 0.6;
            margin-top: 5px;
        }

        /* Report Engine ä¸“ç”¨æ ·å¼ */
        .report-container {
            display: none;
            height: 100%;
            flex-direction: column;
            position: relative;
        }

        .report-container.active {
            display: flex;
        }

        .report-content {
            flex: 1;
            padding: 10px 20px 20px 20px; /* å‡å°‘ä¸Šè¾¹è· */
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 0; /* å…è®¸å­å…ƒç´ ç¼©å° */
            gap: 15px; /* ç»Ÿä¸€å­å…ƒç´ é—´è· */
        }

        .report-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border-bottom: 2px solid #000000;
            background-color: #f8f9fa;
        }

        .report-button {
            padding: 10px 20px;
            border: 2px solid #000000;
            background-color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .report-button:hover {
            background-color: #f0f0f0;
        }

        .report-button:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }

        .report-button.primary {
            background-color: #000000;
            color: #ffffff;
        }

        .report-button.primary:hover {
            background-color: #333333;
        }

        .report-status {
            padding: 15px;
            margin: 0; /* ç§»é™¤marginï¼Œä½¿ç”¨çˆ¶å®¹å™¨çš„gapæ§åˆ¶é—´è· */
            border: 2px solid #000000;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
        }

        .report-status.loading {
            border-color: #b8860b;
            background-color: #faf5e6;
            /* ç¡®ä¿loadingçŠ¶æ€çš„æŠ¥å‘Šæ¡†ä¸ä¼šæ—‹è½¬ */
            animation: none;
        }

        .report-status.success {
            border-color: #4a6741;
            background-color: #f0f5ed;
        }

        .report-status.error {
            border-color: #8b4513;
            background-color: #fdf5e6;
        }

        .report-preview {
            border: 2px solid #000000;
            background-color: #ffffff;
            min-height: 400px;
            max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
            overflow-y: hidden; /* å¼ºåˆ¶ä¸æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
            overflow-x: hidden; /* å¼ºåˆ¶ä¸æ˜¾ç¤ºæ°´å¹³æ»šåŠ¨æ¡ */
            flex: 1; /* è®©é¢„è§ˆåŒºåŸŸå ç”¨å‰©ä½™ç©ºé—´ */
        }

        .report-preview iframe {
            width: 100%;
            min-height: 400px;
            border: none;
            /* è®©iframeè‡ªé€‚åº”å†…å®¹é«˜åº¦ */
            height: auto;
            /* å¼ºåˆ¶ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            overflow: hidden;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        /* éšè—webkitæµè§ˆå™¨çš„æ»šåŠ¨æ¡ */
        .report-preview iframe::-webkit-scrollbar {
            display: none;
        }

        .report-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-size: 14px;
        }

        /* é…ç½®æ¨¡æ€æ¡†æ ·å¼ */
        .config-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .config-modal.show {
            display: block;
        }

        .config-modal-content {
            background-color: #ffffff;
            margin: 2% auto;
            padding: 0;
            border: 3px solid #000000;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .config-modal-header {
            padding: 20px;
            background-color: #000000;
            color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000000;
        }

        .config-modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .config-close {
            color: #ffffff;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }

        .config-close:hover {
            color: #cccccc;
        }

        .config-modal-body {
            padding: 30px;
        }

        .config-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #000000;
            background-color: #f9f9f9;
        }

        .config-section h3 {
            margin: 0 0 20px 0;
            font-size: 20px;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
        }

        .config-group {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #cccccc;
        }

        .config-group h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: bold;
            color: #333333;
        }

        .config-field {
            margin-bottom: 15px;
        }

        .config-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
            color: #333333;
        }

        .config-field input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cccccc;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
        }

        .config-field input:focus {
            outline: none;
            border-color: #000000;
        }

        .config-field input[type="password"] {
            letter-spacing: 2px;
        }

        .config-modal-footer {
            padding: 20px 30px;
            background-color: #f5f5f5;
            border-top: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .config-button {
            padding: 12px 25px;
            border: 2px solid #000000;
            background-color: #000000;
            color: #ffffff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .config-button:hover {
            background-color: #333333;
        }

        .config-button.secondary {
            background-color: #ffffff;
            color: #000000;
        }

        .config-button.secondary:hover {
            background-color: #f0f0f0;
        }

        .config-info {
            font-size: 12px;
            color: #666666;
            margin-top: 5px;
        }

        .config-status {
            padding: 10px 15px;
            border: 2px solid;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .config-status.success {
            border-color: #4a6741;
            background-color: #f0f5ed;
            color: #4a6741;
        }

        .config-status.error {
            border-color: #8b4513;
            background-color: #fdf5e6;
            color: #8b4513;
        }

        .config-button:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æœç´¢æ¡†åŒºåŸŸ -->
        <div class="search-section">
            <div class="search-title">
                å¾®èˆ† - è‡´åŠ›äºæ‰“é€ ç®€æ´é€šç”¨çš„èˆ†æƒ…åˆ†æå¹³å°
                <button class="config-button" id="configButton" onclick="openConfigModal()" style="float: right; padding: 8px 15px; border: 2px solid #000000; background-color: #ffffff; color: #000000; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease;">âš™ï¸ é…ç½®</button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="è¯·è¾“å…¥è¦åˆ†æçš„å†…å®¹...">
                <button class="search-button" id="searchButton">å¼€å§‹</button>
                <button class="upload-button" id="uploadButton">
                    ä¸Šä¼ æ¨¡æ¿
                    <input type="file" id="templateFileInput" accept=".md,.txt" title="ä¸Šä¼ è‡ªå®šä¹‰æŠ¥å‘Šæ¨¡æ¿(æ”¯æŒ .md å’Œ .txt æ–‡ä»¶)">
                </button>
            </div>
            <div class="upload-status" id="uploadStatus"></div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- åµŒå…¥é¡µé¢åŒºåŸŸ -->
            <div class="embedded-section">
                <div class="embedded-header" id="embeddedHeader">åµŒå…¥çš„é¡µé¢</div>
                <div class="embedded-content" id="embeddedContent">
                    <!-- è®ºå›èŠå¤©ç•Œé¢ -->
                    <div class="forum-container" id="forumContainer">
                        <div class="forum-chat-area" id="forumChatArea">
                            <!-- åŠ¨æ€æ·»åŠ çš„Engineå¯¹è¯æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- æŠ¥å‘Šå¼•æ“ç•Œé¢ -->
                    <div class="report-container" id="reportContainer">
                        <div class="report-content" id="reportContent">
                            <!-- æŠ¥å‘Šå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <span>é»˜è®¤åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªé¡µé¢ - ç‚¹å‡»æŒ‰é’®åˆ‡æ¢é¡µé¢</span>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶å°è¾“å‡ºåŒºåŸŸ -->
            <div class="console-section">
                <!-- åº”ç”¨åˆ‡æ¢æŒ‰é’® -->
                <div class="app-switcher">
                    <button class="app-button active" data-app="insight">
                        <span class="status-indicator" id="status-insight"></span>
                        Insight Engine
                    </button>
                    <button class="app-button" data-app="media">
                        <span class="status-indicator" id="status-media"></span>
                        Media Engine
                    </button>
                    <button class="app-button" data-app="query">
                        <span class="status-indicator" id="status-query"></span>
                        Query Engine
                    </button>
                    <button class="app-button" data-app="forum">
                        <span class="status-indicator running" id="status-forum"></span>
                        Forum Engine
                    </button>
                    <button class="app-button locked" data-app="report" title="éœ€ç­‰å¾…å…¶ä½™ä¸‰ä¸ªAgentå·¥ä½œå®Œæ¯•">
                        <span class="status-indicator" id="status-report"></span>
                        Report Engine
                    </button>
                </div>

                <!-- æ§åˆ¶å°è¾“å‡º -->
                <div class="console-output" id="consoleOutput">
                    <div class="console-line">[ç³»ç»Ÿ] ç­‰å¾…è¿æ¥...</div>
                </div>
            </div>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <span id="connectionStatus">è¿æ¥ä¸­...</span>
            <span id="systemTime"></span>
        </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div class="message" id="message"></div>

    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div class="config-modal" id="configModal" role="dialog" aria-modal="true" aria-labelledby="configModalTitle">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h2 id="configModalTitle">é…ç½®ä¸å¯†é’¥ç®¡ç†</h2>
                <button type="button" class="config-close" onclick="closeConfigModal()" aria-label="å…³é—­é…ç½®çª—å£">Ã—</button>
            </div>
            <form id="configForm">
                <div class="config-modal-body">
                    <div id="configStatus" class="config-status" style="display: none;"></div>

                    <div class="config-section">
                        <h3>å¼•æ“ LLM é…ç½®</h3>
                        <p class="config-info">åœ¨è¿™é‡Œé…ç½®å„ä¸ªå¼•æ“æ‰€ä½¿ç”¨çš„å¤§è¯­è¨€æ¨¡å‹æœåŠ¡çš„ API Keyã€Base URL ä¸æ¨¡å‹åç§°ã€‚é…ç½®å†…å®¹ä¼šä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ï¼Œåˆ·æ–°é¡µé¢åè‡ªåŠ¨ç”Ÿæ•ˆã€‚</p>
                        <div id="engineConfigContainer"></div>
                    </div>

                    <div class="config-section">
                        <h3>æ£€ç´¢ä¸å·¥å…·é…ç½®</h3>
                        <div class="config-group">
                            <h4>Tavily æœç´¢</h4>
                            <div class="config-field">
                                <label for="tavilyApiKey">Tavily API Key</label>
                                <input type="text" id="tavilyApiKey" name="tavily_api_key" placeholder="ä¾‹å¦‚ï¼štvly-xxxxxxxx">
                                <div class="config-info">ç”¨äº Query Agent çš„è”ç½‘æ£€ç´¢èƒ½åŠ›ã€‚</div>
                            </div>
                        </div>
                        <div class="config-group">
                            <h4>Bocha Web Search</h4>
                            <div class="config-field">
                                <label for="bochaApiKey">Bocha API Key</label>
                                <input type="text" id="bochaApiKey" name="bocha_api_key" placeholder="ä¾‹å¦‚ï¼šsk-xxxxxxxx">
                                <div class="config-info">ç”¨äº Media Agent çš„ç½‘é¡µæœç´¢ä¸å¤šæ¨¡æ€åˆ†æã€‚</div>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>MindSpider çˆ¬è™«é…ç½®</h3>
                        <div class="config-group">
                            <h4>DeepSeek API</h4>
                            <div class="config-field">
                                <label for="mindspiderDeepseekApiKey">DeepSeek API Key</label>
                                <input type="text" id="mindspiderDeepseekApiKey" name="mindspider_deepseek_api_key" placeholder="ä¾‹å¦‚ï¼šsk-deepseek-xxxxxxxx">
                                <div class="config-info">ç”¨äº MindSpider çˆ¬è™«çš„é«˜çº§è¯é¢˜æŒ–æ˜ä¸å…³é”®è¯ç”Ÿæˆã€‚å¦‚æœç•™ç©ºï¼Œå°†è‡ªåŠ¨æ²¿ç”¨ Query Engine çš„ DeepSeek é…ç½®ã€‚</div>
                            </div>
                        </div>
                        <p class="config-info">MindSpider çˆ¬è™«ä½¿ç”¨ä¸ä¸»ç³»ç»Ÿç›¸åŒçš„æ•°æ®åº“é…ç½®ã€‚æ•°æ®åº“è¿æ¥ä¿¡æ¯è¯·åœ¨ config.py æˆ–ç¯å¢ƒå˜é‡ä¸­é…ç½®ã€‚</p>
                    </div>

                    <div class="config-section">
                        <h3>é«˜çº§å‚æ•°é…ç½® âš™ï¸</h3>
                        <div class="config-group">
                            <h4>Query Engine é«˜çº§å‚æ•°</h4>
                            <div class="config-field">
                                <label for="queryMaxReflections">åæ€è½®æ¬¡</label>
                                <input type="number" id="queryMaxReflections" min="1" max="10" value="2">
                                <div class="config-info">Query Agent å†…éƒ¨æ€è€ƒå’Œä¼˜åŒ–çš„è½®æ¬¡ã€‚å¢åŠ å¯æå‡è´¨é‡ï¼Œä½†è€—æ—¶æ›´é•¿ã€‚</div>
                            </div>
                            <div class="config-field">
                                <label for="queryMaxSearchResults">æœ€å¤§æœç´¢ç»“æœæ•°</label>
                                <input type="number" id="queryMaxSearchResults" min="5" max="50" value="20">
                                <div class="config-info">ä»æœç´¢APIè·å–çš„æœ€å¤§ç»“æœæ•°é‡ã€‚</div>
                            </div>
                            <div class="config-field">
                                <label for="queryMaxContentLength">æœ€å¤§å†…å®¹é•¿åº¦</label>
                                <input type="number" id="queryMaxContentLength" min="1000" max="100000" value="20000">
                                <div class="config-info">å•æ¬¡å¤„ç†çš„æœ€å¤§æ–‡æœ¬å­—ç¬¦æ•°ã€‚</div>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>Media Engine é«˜çº§å‚æ•°</h4>
                            <div class="config-field">
                                <label for="mediaMaxReflections">åæ€è½®æ¬¡</label>
                                <input type="number" id="mediaMaxReflections" min="1" max="10" value="2">
                            </div>
                            <div class="config-field">
                                <label for="mediaMaxParagraphs">æœ€å¤§æ®µè½æ•°</label>
                                <input type="number" id="mediaMaxParagraphs" min="1" max="20" value="5">
                                <div class="config-info">ç”ŸæˆæŠ¥å‘Šçš„æœ€å¤§æ®µè½æ•°é‡ã€‚</div>
                            </div>
                        </div>

                        <div class="config-group">
                            <h4>Insight Engine é«˜çº§å‚æ•°</h4>
                            <div class="config-field">
                                <label for="insightMaxReflections">åæ€è½®æ¬¡</label>
                                <input type="number" id="insightMaxReflections" min="1" max="10" value="3">
                            </div>
                            <div class="config-field">
                                <label for="insightSearchHotContentLimit">çƒ­ç‚¹å†…å®¹æœç´¢é™åˆ¶</label>
                                <input type="number" id="insightSearchHotContentLimit" min="10" max="500" value="100">
                                <div class="config-info">ä»æ•°æ®åº“è·å–çƒ­ç‚¹å†…å®¹çš„æœ€å¤§æ•°é‡ã€‚</div>
                            </div>
                            <div class="config-field">
                                <label for="insightGetCommentsLimit">è¯„è®ºè·å–é™åˆ¶</label>
                                <input type="number" id="insightGetCommentsLimit" min="50" max="2000" value="500">
                                <div class="config-info">æ¯ä¸ªè¯é¢˜è·å–çš„æœ€å¤§è¯„è®ºæ•°ã€‚</div>
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>æƒ…æ„Ÿåˆ†æé…ç½® ğŸ’¬</h3>
                        <div class="config-group">
                            <div class="config-field">
                                <label for="sentimentModelType">æ¨¡å‹ç±»å‹</label>
                                <select id="sentimentModelType">
                                    <option value="multilingual">å¤šè¯­è¨€æ¨¡å‹ï¼ˆæ¨èï¼‰</option>
                                    <option value="bert">ä¸­æ–‡BERTæ¨¡å‹</option>
                                    <option value="qwen">Qwenæƒ…æ„Ÿæ¨¡å‹</option>
                                </select>
                                <div class="config-info">æ ¹æ®éƒ¨ç½²ç¯å¢ƒé€‰æ‹©åˆé€‚çš„æƒ…æ„Ÿåˆ†ææ¨¡å‹ã€‚</div>
                            </div>
                            <div class="config-field">
                                <label for="sentimentConfidenceThreshold">ç½®ä¿¡åº¦é˜ˆå€¼</label>
                                <input type="number" id="sentimentConfidenceThreshold" step="0.05" min="0" max="1" value="0.8">
                            </div>
                            <div class="config-field">
                                <label for="sentimentBatchSize">æ‰¹å¤„ç†å¤§å°</label>
                                <input type="number" id="sentimentBatchSize" min="1" max="128" value="32">
                            </div>
                            <div class="config-field">
                                <label for="sentimentMaxSequenceLength">æœ€å¤§åºåˆ—é•¿åº¦</label>
                                <input type="number" id="sentimentMaxSequenceLength" min="64" max="2048" value="512">
                            </div>
                        </div>
                    </div>

                    <div class="config-section">
                        <h3>WebDAV å¤‡ä»½é…ç½® â˜ï¸</h3>
                        <p class="config-info">é…ç½®WebDAVæœåŠ¡å™¨ï¼Œå¯ä»¥å°†é…ç½®è‡ªåŠ¨å¤‡ä»½åˆ°äº‘ç«¯ï¼ˆå¦‚ï¼šåšæœäº‘ã€Nextcloudç­‰ï¼‰ã€‚</p>
                        <div class="config-group">
                            <div class="config-field">
                                <label for="webdavUrl">WebDAV æœåŠ¡å™¨åœ°å€</label>
                                <input type="text" id="webdavUrl" placeholder="ä¾‹å¦‚ï¼šhttps://dav.jianguoyun.com/dav/">
                                <div class="config-info">WebDAVæœåŠ¡å™¨çš„å®Œæ•´URLåœ°å€ã€‚</div>
                            </div>
                            <div class="config-field">
                                <label for="webdavUsername">ç”¨æˆ·å</label>
                                <input type="text" id="webdavUsername" placeholder="WebDAVç”¨æˆ·å">
                            </div>
                            <div class="config-field">
                                <label for="webdavPassword">å¯†ç /åº”ç”¨å¯†ç </label>
                                <input type="password" id="webdavPassword" placeholder="WebDAVå¯†ç æˆ–åº”ç”¨ä¸“ç”¨å¯†ç ">
                                <div class="config-info">éƒ¨åˆ†æœåŠ¡éœ€è¦åº”ç”¨ä¸“ç”¨å¯†ç ï¼ˆå¦‚åšæœäº‘ï¼‰ã€‚</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-modal-footer">
                    <button type="button" class="config-button secondary" onclick="resetConfigToDefaults()">æ¢å¤æ¨èé…ç½®</button>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="config-button secondary" onclick="exportConfigToLocal()">ğŸ’¾ å¯¼å‡ºåˆ°æœ¬åœ°</button>
                        <button type="button" class="config-button secondary" onclick="importConfigFromLocal()">ğŸ“‚ ä»æœ¬åœ°å¯¼å…¥</button>
                        <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="handleConfigFileSelect(event)">
                        <button type="button" class="config-button secondary" onclick="backupToWebDAV()">â˜ï¸ å¤‡ä»½åˆ°WebDAV</button>
                        <button type="button" class="config-button secondary" onclick="restoreFromWebDAV()">â˜ï¸ ä»WebDAVæ¢å¤</button>
                        <button type="button" class="config-button secondary" onclick="closeConfigModal()">å–æ¶ˆ</button>
                        <button type="submit" class="config-button">ä¿å­˜é…ç½®</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket;
        let currentApp = 'insight';
        let appStatus = {
            insight: 'stopped',
            media: 'stopped',
            query: 'stopped',
            forum: 'running',  // Forum Engine é»˜è®¤è¿è¡Œ
            report: 'stopped'  // Report Engine
        };
        let customTemplate = ''; // å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„è‡ªå®šä¹‰æ¨¡æ¿å†…å®¹

        // åº”ç”¨åç§°æ˜ å°„
        const appNames = {
            insight: 'Insight Engine',
            media: 'Media Engine', 
            query: 'Query Engine',
            forum: 'Forum Engine',
            report: 'Report Engine'
        };

        // é¡µé¢å¤´éƒ¨æ˜¾ç¤ºçš„å®Œæ•´Agentä»‹ç»
        const agentTitles = {
            insight: 'Insight Agent - ç§æœ‰æ•°æ®åº“æŒ–æ˜',
            media: 'Media Agent - å¤šæ¨¡æ€å†…å®¹åˆ†æ', 
            query: 'Query Agent - ç²¾å‡†ä¿¡æ¯æœç´¢',
            forum: 'Forum Engine - å¤šæ™ºèƒ½ä½“äº¤æµ',
            report: 'Report Agent - æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ'
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeEventListeners();
            updateTime();
            setInterval(updateTime, 1000);
            checkStatus();
            setInterval(checkStatus, 5000);
            
            // åˆå§‹åŒ–Report Engineé”å®šçŠ¶æ€æ£€æŸ¥
            checkReportLockStatus();
            reportLockCheckInterval = setInterval(checkReportLockStatus, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
            
            // å®šæœŸåˆ·æ–°æ§åˆ¶å°è¾“å‡º
            setInterval(() => {
                refreshConsoleOutput();
            }, 1000);
            
            // å®šæœŸåˆ·æ–°è®ºå›å¯¹è¯ï¼ˆå®æ—¶æ›´æ–°ï¼‰
            setInterval(() => {
                refreshForumMessages();
            }, 2000);
            
            // åˆå§‹åŒ–è®ºå›ç›¸å…³åŠŸèƒ½
            initializeForum();
            
            // å»¶è¿Ÿé¢„åŠ è½½iframeä»¥ç¡®ä¿åº”ç”¨å¯åŠ¨å®Œæˆ
            setTimeout(() => {
                preloadIframes();
            }, 3000);
        });

        // Socket.IOè¿æ¥
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus('å·²è¿æ¥');
                socket.emit('request_status');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus('è¿æ¥æ–­å¼€');
            });

            socket.on('console_output', function(data) {
                // å¤„ç†æ§åˆ¶å°è¾“å‡º
                if (data.app === currentApp) {
                    addConsoleOutput(data.line);
                }
                
                // å¦‚æœæ˜¯forumçš„è¾“å‡ºï¼ŒåŒæ—¶ä¹Ÿå¤„ç†ä¸ºè®ºå›æ¶ˆæ¯
                if (data.app === 'forum') {
                    const parsed = parseForumMessage(data.line);
                    if (parsed) {
                        // addForumMessage(parsed);
                    }
                }
            });

            socket.on('forum_message', function(data) {
                // addForumMessage(data);
            });

            socket.on('status_update', function(data) {
                updateAppStatus(data);
            });
        }

        // äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æœç´¢æŒ‰é’®
            document.getElementById('searchButton').addEventListener('click', performSearch);
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('templateFileInput').addEventListener('change', handleTemplateUpload);

            // åº”ç”¨åˆ‡æ¢æŒ‰é’®
            document.querySelectorAll('.app-button').forEach(button => {
                button.addEventListener('click', function() {
                    const app = this.dataset.app;
                    switchToApp(app);
                });
            });
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showMessage('è¯·è¾“å…¥æœç´¢å†…å®¹', 'error');
                return;
            }

            const button = document.getElementById('searchButton');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> æœç´¢ä¸­...';

            // æ¸…é™¤ç°æœ‰æŠ¥å‘Šï¼Œé‡ç½®è‡ªåŠ¨ç”Ÿæˆæ ‡å¿—ï¼Œä¸ºæ–°æœç´¢åšå‡†å¤‡
            const reportPreview = document.getElementById('reportPreview');
            if (reportPreview) {
                reportPreview.innerHTML = '<div class="report-loading">ç­‰å¾…æ–°çš„æœç´¢ç»“æœç”ŸæˆæŠ¥å‘Š...</div>';
            }
            
            // æ¸…é™¤ä»»åŠ¡è¿›åº¦æ˜¾ç¤º
            const taskProgressArea = document.getElementById('taskProgressArea');
            if (taskProgressArea) {
                taskProgressArea.innerHTML = '';
            }
            
            // é‡ç½®è‡ªåŠ¨ç”Ÿæˆç›¸å…³æ ‡å¿—
            autoGenerateTriggered = false;
            reportTaskId = null;
            
            // åœæ­¢å¯èƒ½æ­£åœ¨è¿›è¡Œçš„è½®è¯¢
            if (reportPollingInterval) {
                clearInterval(reportPollingInterval);
                reportPollingInterval = null;
            }

            // ç¡®ä¿æ‰€æœ‰iframeå·²åˆå§‹åŒ–
            if (!iframesInitialized) {
                preloadIframes();
            }
            
            // å‘æ‰€æœ‰è¿è¡Œä¸­çš„åº”ç”¨å‘é€æœç´¢è¯·æ±‚ï¼ˆé€šè¿‡åˆ·æ–°iframeä¼ é€’å‚æ•°ï¼‰
            let totalRunning = 0;
            const ports = { insight: 8501, media: 8502, query: 8503 };
            
            Object.keys(appStatus).forEach(app => {
                if (appStatus[app] === 'running' && preloadedIframes[app]) {
                    totalRunning++;
                    
                    // æ„å»ºæœç´¢URL
                    const searchUrl = `http://localhost:${ports[app]}?query=${encodeURIComponent(query)}&auto_search=true`;
                    console.log(`å‘ ${app} å‘é€æœç´¢è¯·æ±‚: ${searchUrl}`);
                    
                    // ç›´æ¥æ›´æ–°ä¸»iframeçš„srcæ¥ä¼ é€’æœç´¢å‚æ•°
                    preloadedIframes[app].src = searchUrl;
                }
            });
            
            if (totalRunning === 0) {
                button.disabled = false;
                button.innerHTML = 'æœç´¢';
                showMessage('æ²¡æœ‰è¿è¡Œä¸­çš„åº”ç”¨ï¼Œæ— æ³•æ‰§è¡Œæœç´¢', 'error');
            } else {
                button.disabled = false;
                button.innerHTML = 'æœç´¢';
                showMessage(`æœç´¢è¯·æ±‚å·²å‘é€åˆ° ${totalRunning} ä¸ªåº”ç”¨ï¼Œé¡µé¢å°†åˆ·æ–°ä»¥å¼€å§‹ç ”ç©¶`, 'success');
            }
        }

        // åˆ‡æ¢åº”ç”¨
        function switchToApp(app) {
            if (app === currentApp) return;

            // æ£€æŸ¥Report Engineæ˜¯å¦è¢«é”å®š
            if (app === 'report') {
                const reportButton = document.querySelector(`[data-app="report"]`);
                if (reportButton.classList.contains('locked')) {
                    showMessage('éœ€ç­‰å¾…å…¶ä½™ä¸‰ä¸ªAgentå·¥ä½œå®Œæ¯•', 'error');
                    return;
                }
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.app-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-app="${app}"]`).classList.add('active');

            currentApp = app;

            // æ ¹æ®åº”ç”¨ç±»å‹å¤„ç†ä¸åŒçš„æ˜¾ç¤ºé€»è¾‘
            if (app === 'forum') {
                // åˆ‡æ¢åˆ°è®ºå›æ¨¡å¼
                document.getElementById('embeddedHeader').textContent = 'Forum Engine - å¤šæ™ºèƒ½ä½“äº¤æµ';
                
                // æ˜¾ç¤ºè®ºå›å®¹å™¨ï¼Œéšè—å…¶ä»–å†…å®¹
                document.getElementById('forumContainer').classList.add('active');
                document.getElementById('reportContainer').classList.remove('active');
                
                // æ¸…ç©ºæ§åˆ¶å°å¹¶åŠ è½½forumæ—¥å¿—
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[ç³»ç»Ÿ] åˆ‡æ¢åˆ°è®ºå›æ¨¡å¼</div>';
                loadForumLog();
                
            } else if (app === 'report') {
                // åˆ‡æ¢åˆ°æŠ¥å‘Šæ¨¡å¼
                document.getElementById('embeddedHeader').textContent = 'Report Agent - æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ';
                
                // æ˜¾ç¤ºæŠ¥å‘Šå®¹å™¨ï¼Œéšè—å…¶ä»–å†…å®¹
                document.getElementById('reportContainer').classList.add('active');
                document.getElementById('forumContainer').classList.remove('active');
                
                // æ¸…ç©ºæ§åˆ¶å°å¹¶åŠ è½½reportæ—¥å¿—
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[ç³»ç»Ÿ] åˆ‡æ¢åˆ°æŠ¥å‘Šç”Ÿæˆæ¨¡å¼</div>';
                loadReportLog();
                
                // åªåœ¨æŠ¥å‘Šç•Œé¢æœªåˆå§‹åŒ–æ—¶æ‰é‡æ–°åŠ è½½
                const reportContent = document.getElementById('reportContent');
                if (!reportContent || reportContent.children.length === 0) {
                    loadReportInterface();
                }
                
                // åˆ‡æ¢åˆ°reporté¡µé¢æ—¶æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
                setTimeout(() => {
                    checkReportLockStatus();
                }, 500);
                
            } else {
                // åˆ‡æ¢åˆ°æ™®é€šEngineæ¨¡å¼
                document.getElementById('embeddedHeader').textContent = agentTitles[app] || appNames[app];
                
                // éšè—è®ºå›å’ŒæŠ¥å‘Šå®¹å™¨
                document.getElementById('forumContainer').classList.remove('active');
                document.getElementById('reportContainer').classList.remove('active');
                
                // æ¸…ç©ºå¹¶åŠ è½½æ–°çš„æ§åˆ¶å°è¾“å‡º
                document.getElementById('consoleOutput').innerHTML = '<div class="console-line">[ç³»ç»Ÿ] åˆ‡æ¢åˆ° ' + appNames[app] + '</div>';
                
                // é‡ç½®è¡Œè®¡æ•°
                lastLineCount[app] = 0;
                loadConsoleOutput(app);
            }

            // æ›´æ–°åµŒå…¥é¡µé¢
            updateEmbeddedPage(app);
        }

        // å­˜å‚¨æœ€åæ˜¾ç¤ºçš„è¡Œæ•°ï¼Œé¿å…é‡å¤åŠ è½½
        let lastLineCount = {};
        
        // åŠ è½½æ§åˆ¶å°è¾“å‡º
        function loadConsoleOutput(app) {
            if (app === 'forum') {
                loadForumLog();
                return;
            }
            
            if (app === 'report') {
                loadReportLog();
                return;
            }
            
            fetch(`/api/output/${app}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.output.length > 0) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    
                    // åªæ·»åŠ æ–°çš„è¡Œ
                    const lastCount = lastLineCount[app] || 0;
                    const newLines = data.output.slice(lastCount);
                    
                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);
                    });
                    
                    lastLineCount[app] = data.output.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => {
                console.error('åŠ è½½è¾“å‡ºå¤±è´¥:', error);
            });
        }
        
        // åˆ·æ–°å½“å‰åº”ç”¨çš„æ§åˆ¶å°è¾“å‡º
        function refreshConsoleOutput() {
            if (currentApp === 'forum') {
                refreshForumLog();
                return;
            }
            
            if (currentApp === 'report') {
                refreshReportLog();
                return;
            }
            
            if (appStatus[currentApp] === 'running' || appStatus[currentApp] === 'starting') {
                fetch(`/api/output/${currentApp}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.output.length > 0) {
                        const consoleOutput = document.getElementById('consoleOutput');
                        
                        // åªæ·»åŠ æ–°çš„è¡Œ
                        const lastCount = lastLineCount[currentApp] || 0;
                        const newLines = data.output.slice(lastCount);
                        
                        if (newLines.length > 0) {
                            newLines.forEach(line => {
                                const div = document.createElement('div');
                                div.className = 'console-line';
                                div.textContent = line;
                                consoleOutput.appendChild(div);
                            });
                            
                            lastLineCount[currentApp] = data.output.length;
                            consoleOutput.scrollTop = consoleOutput.scrollHeight;
                        }
                    }
                })
                .catch(error => {
                    console.error('åˆ·æ–°è¾“å‡ºå¤±è´¥:', error);
                });
            }
        }

        // æ·»åŠ æ§åˆ¶å°è¾“å‡º
        function addConsoleOutput(line) {
            const consoleOutput = document.getElementById('consoleOutput');
            const div = document.createElement('div');
            div.className = 'console-line';
            div.textContent = line;
            consoleOutput.appendChild(div);

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨æ˜¾ç¤ºæœ€æ–°å†…å®¹
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // é¢„åŠ è½½çš„iframeå­˜å‚¨
        let preloadedIframes = {};
        let iframesInitialized = false;
        
        // é¢„åŠ è½½æ‰€æœ‰iframeï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰
        function preloadIframes() {
            if (iframesInitialized) return;
            
            const ports = { insight: 8501, media: 8502, query: 8503 };
            const content = document.getElementById('embeddedContent');
            
            for (const [app, port] of Object.entries(ports)) {
                const iframe = document.createElement('iframe');
                iframe.src = `http://localhost:${port}`;
                iframe.style.width = '100%';
                iframe.style.height = '100%';
                iframe.style.border = 'none';
                iframe.style.position = 'absolute';
                iframe.style.top = '0';
                iframe.style.left = '0';
                iframe.style.display = 'none';
                iframe.id = `iframe-${app}`;
                
                // ç›´æ¥æ·»åŠ åˆ°contentåŒºåŸŸ
                content.appendChild(iframe);
                preloadedIframes[app] = iframe;
                
                console.log(`é¢„åŠ è½½ ${app} åº”ç”¨å®Œæˆ`);
            }
            
            iframesInitialized = true;
            console.log('æ‰€æœ‰iframeé¢„åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿›è¡Œæ— ç¼åˆ‡æ¢');
        }

        // æ›´æ–°åµŒå…¥é¡µé¢
        function updateEmbeddedPage(app) {
            const header = document.getElementById('embeddedHeader');
            const content = document.getElementById('embeddedContent');
            
            // å¦‚æœæ˜¯Forum Engineï¼Œç›´æ¥æ˜¾ç¤ºè®ºå›ç•Œé¢
            if (app === 'forum') {
                header.textContent = 'Forum Engine - å¤šæ™ºèƒ½ä½“äº¤æµ';
                
                // éšè—æ‰€æœ‰iframe
                if (typeof preloadedIframes !== 'undefined') {
                    Object.values(preloadedIframes).forEach(iframe => {
                        iframe.style.display = 'none';
                    });
                }
                
                // ç§»é™¤å ä½ç¬¦
                const placeholder = content.querySelector('.status-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // æ˜¾ç¤ºè®ºå›å®¹å™¨ï¼Œéšè—æŠ¥å‘Šå®¹å™¨
                document.getElementById('forumContainer').classList.add('active');
                document.getElementById('reportContainer').classList.remove('active');
                return;
            }
            
            // å¦‚æœæ˜¯Report Engineï¼Œæ˜¾ç¤ºæŠ¥å‘Šç•Œé¢
            if (app === 'report') {
                header.textContent = 'Report Agent - æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ';
                
                // éšè—æ‰€æœ‰iframe
                if (typeof preloadedIframes !== 'undefined') {
                    Object.values(preloadedIframes).forEach(iframe => {
                        iframe.style.display = 'none';
                    });
                }
                
                // ç§»é™¤å ä½ç¬¦
                const placeholder = content.querySelector('.status-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // æ˜¾ç¤ºæŠ¥å‘Šå®¹å™¨ï¼Œéšè—è®ºå›å®¹å™¨
                document.getElementById('reportContainer').classList.add('active');
                document.getElementById('forumContainer').classList.remove('active');
                return;
            }
            
            // éšè—è®ºå›å’ŒæŠ¥å‘Šå®¹å™¨
            document.getElementById('forumContainer').classList.remove('active');
            document.getElementById('reportContainer').classList.remove('active');

            header.textContent = agentTitles[app] || appNames[app] || app;

            // å¦‚æœåº”ç”¨æ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤ºå¯¹åº”çš„iframe
            if (appStatus[app] === 'running') {
                // ç¡®ä¿iframeå·²åˆå§‹åŒ–
                if (!iframesInitialized) {
                    preloadIframes();
                }
                
                // éšè—æ‰€æœ‰iframe
                Object.values(preloadedIframes).forEach(iframe => {
                    iframe.style.display = 'none';
                });
                
                // ç§»é™¤å ä½ç¬¦
                const placeholder = content.querySelector('.status-placeholder');
                if (placeholder) {
                    placeholder.remove();
                }
                
                // æ˜¾ç¤ºå½“å‰åº”ç”¨çš„iframe
                if (preloadedIframes[app]) {
                    preloadedIframes[app].style.display = 'block';
                    console.log(`åˆ‡æ¢åˆ° ${app} åº”ç”¨ - æ— åˆ·æ–°åˆ‡æ¢`);
                }
            } else {
                // éšè—æ‰€æœ‰iframe
                Object.values(preloadedIframes).forEach(iframe => {
                    iframe.style.display = 'none';
                });
                
                // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
                let placeholder = content.querySelector('.status-placeholder');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'status-placeholder';
                    placeholder.style.cssText = 'display: flex; align-items: center; justify-content: center; height: 100%; color: #666; flex-direction: column; position: absolute; top: 0; left: 0; width: 100%;';
                    content.appendChild(placeholder);
                }
                
                placeholder.innerHTML = `
                    <div style="margin-bottom: 10px;">${appNames[app]} æœªè¿è¡Œ</div>
                    <div style="font-size: 12px;">çŠ¶æ€: ${appStatus[app]}</div>
                `;
            }
        }

        // æ£€æŸ¥åº”ç”¨çŠ¶æ€
        function checkStatus() {
            fetch('/api/status')
            .then(response => response.json())
            .then(data => {
                updateAppStatus(data);
            })
            .catch(error => {
                console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
            });
        }

        // æ›´æ–°åº”ç”¨çŠ¶æ€
        function updateAppStatus(data) {
            for (const [app, info] of Object.entries(data)) {
                // é€‚é…å®é™…çš„APIæ ¼å¼ï¼š{app: {status: string, port: int, output_lines: int}}
                const status = info.status === 'running' ? 'running' : 'stopped';
                appStatus[app] = status;
                
                const indicator = document.getElementById(`status-${app}`);
                if (indicator) {
                    indicator.className = `status-indicator ${status}`;
                }
            }

            // å¦‚æœå½“å‰æ˜¾ç¤ºçš„åº”ç”¨çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°åµŒå…¥é¡µé¢
            updateEmbeddedPage(currentApp);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN');
            document.getElementById('systemTime').textContent = timeString;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type = 'info') {
            const message = document.getElementById('message');
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (message.hideTimer) {
                clearTimeout(message.hideTimer);
            }
            
            message.textContent = text;
            message.className = `message ${type}`;
            message.classList.add('show');

            message.hideTimer = setTimeout(() => {
                message.classList.remove('show');
                // å»¶è¿Ÿæ¸…é™¤å†…å®¹ï¼Œç­‰å¾…åŠ¨ç”»å®Œæˆ
                setTimeout(() => {
                    message.textContent = '';
                    message.className = 'message';
                }, 300);
            }, 3000);
        }

        // å¤„ç†æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ 
        function handleTemplateUpload(event) {
            const file = event.target.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!file) {
                statusDiv.textContent = '';
                statusDiv.className = 'upload-status';
                customTemplate = '';
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const allowedTypes = ['text/markdown', 'text/plain', '.md', '.txt'];
            const fileName = file.name.toLowerCase();
            const isValidType = fileName.endsWith('.md') || fileName.endsWith('.txt') || 
                              allowedTypes.includes(file.type);

            if (!isValidType) {
                statusDiv.textContent = 'é”™è¯¯: è¯·é€‰æ‹© .md æˆ– .txt æ–‡ä»¶';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = ''; // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                return;
            }

            // æ£€æŸ¥æ–‡ä»¶å¤§å° (æœ€å¤§ 1MB)
            const maxSize = 1024 * 1024; // 1MB
            if (file.size > maxSize) {
                statusDiv.textContent = 'é”™è¯¯: æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 1MB';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = '';
                return;
            }

            statusDiv.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';
            statusDiv.className = 'upload-status';

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    customTemplate = e.target.result;
                    statusDiv.textContent = `æˆåŠŸ: å·²åŠ è½½è‡ªå®šä¹‰æ¨¡æ¿ "${file.name}" (${(file.size/1024).toFixed(1)}KB)`;
                    statusDiv.className = 'upload-status success';
                    showMessage(`è‡ªå®šä¹‰æ¨¡æ¿å·²åŠ è½½: ${file.name}`, 'success');
                } catch (error) {
                    statusDiv.textContent = 'é”™è¯¯: æ–‡ä»¶è¯»å–å¤±è´¥';
                    statusDiv.className = 'upload-status error';
                    customTemplate = '';
                    event.target.value = '';
                }
            };

            reader.onerror = function() {
                statusDiv.textContent = 'é”™è¯¯: æ–‡ä»¶è¯»å–å¤±è´¥';
                statusDiv.className = 'upload-status error';
                customTemplate = '';
                event.target.value = '';
            };

            reader.readAsText(file, 'utf-8');
        }

        // Forum Engine ç›¸å…³å‡½æ•°
        let forumLogLineCount = 0;
        
        // Report Engine ç›¸å…³å‡½æ•°
        let reportLogLineCount = 0;
        let reportLockCheckInterval = null;

        // å®æ—¶åˆ·æ–°è®ºå›æ¶ˆæ¯ï¼ˆé€‚ç”¨äºæ‰€æœ‰é¡µé¢ï¼‰
        function refreshForumMessages() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > forumLogLineCount) {
                    console.log(`Forum: å‘ç°æ–°æ¶ˆæ¯ï¼Œå½“å‰è¡Œæ•°: ${data.log_lines.length}, ä¸Šæ¬¡å¤„ç†: ${forumLogLineCount}`);
                    
                    // åªå¤„ç†æ–°å¢çš„æ—¥å¿—è¡Œ
                    const newLines = data.log_lines.slice(forumLogLineCount);
                    newLines.forEach((line, index) => {
                        console.log(`Forum: å¤„ç†æ–°è¡Œ ${forumLogLineCount + index + 1}: ${line}`);
                        const parsed = parseForumMessage(line);
                        if (parsed) {
                            console.log(`Forum: è§£ææˆåŠŸï¼Œæ·»åŠ æ¶ˆæ¯:`, parsed);
                            addForumMessage(parsed);
                        }
                    });
                    forumLogLineCount = data.log_lines.length;
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°è®ºå›æ¶ˆæ¯å¤±è´¥:', error);
            });
        }

        // åˆå§‹åŒ–è®ºå›åŠŸèƒ½
        function initializeForum() {
            // åˆå§‹åŒ–æ—¶åŠ è½½ä¸€æ¬¡è®ºå›æ—¥å¿—
            refreshForumMessages();
        }

        // åŠ è½½è®ºå›æ—¥å¿—
        function loadForumLog() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¸…ç©ºå¯¹è¯åŒº
                    const chatArea = document.getElementById('forumChatArea');
                    chatArea.innerHTML += `
                        <div class="forum-message system">
                            <div class="forum-message-header">SYSTEM</div>
                            <div class="forum-message-content">ForumEngine è®ºå›å·²å¯åŠ¨ï¼ŒIDï¼š98fiaw4324dwadhsl21awhs908147</div>
                            <div class="forum-timestamp">${new Date().toLocaleTimeString('zh-CN')}</div>
                        </div>
                    `;
                    
                    // åŠ è½½æ§åˆ¶å°æ—¥å¿—
                    const consoleOutput = document.getElementById('consoleOutput');
                    consoleOutput.innerHTML = '<div class="console-line">[ç³»ç»Ÿ] Forum Engine æ—¥å¿—è¾“å‡º</div>';
                    
                    if (data.log_lines && data.log_lines.length > 0) {
                        data.log_lines.forEach(line => {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = line;
                            consoleOutput.appendChild(div);
                            
                            // è§£æå¹¶æ·»åŠ åˆ°å¯¹è¯åŒº
                            const parsed = parseForumMessage(line);
                            //if (parsed) {
                                //addForumMessage(parsed);
                            //}
                        });
                        
                        // é‡ç½®è®¡æ•°å™¨ä»¥ç¡®ä¿åç»­æ¶ˆæ¯èƒ½æ­£ç¡®æ˜¾ç¤º
                        forumLogLineCount = data.log_lines.length;
                    } else {
                        // å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œé‡ç½®è®¡æ•°å™¨
                        forumLogLineCount = 0;
                    }
                    
                    // å¦‚æœæœ‰è§£æçš„æ¶ˆæ¯ï¼Œç›´æ¥ä½¿ç”¨
                    if (data.parsed_messages && data.parsed_messages.length > 0) {
                        data.parsed_messages.forEach(message => {
                            // addForumMessage(message);
                        });
                    }
                    
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => {
                console.error('åŠ è½½è®ºå›æ—¥å¿—å¤±è´¥:', error);
            });
        }

        // åˆ·æ–°è®ºå›æ—¥å¿—
        function refreshForumLog() {
            fetch('/api/forum/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > forumLogLineCount) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    
                    // åªæ·»åŠ æ–°çš„è¡Œ
                    const newLines = data.log_lines.slice(forumLogLineCount);
                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);
                        
                        // å¦‚æœæ˜¯è®ºå›å¯¹è¯å†…å®¹ï¼Œä¹Ÿæ˜¾ç¤ºåˆ°å·¦ä¾§å¯¹è¯åŒº
                        const parsed = parseForumMessage(line);
                        if (parsed) {
                            addForumMessage(parsed);
                        }
                    });
                    
                    forumLogLineCount = data.log_lines.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°è®ºå›æ—¥å¿—å¤±è´¥:', error);
            });
        }

        // åˆ·æ–°Report Engineæ—¥å¿—
        // æ£€æŸ¥Report Engineé”å®šçŠ¶æ€å¹¶è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
        let autoGenerateTriggered = false; // é˜²æ­¢é‡å¤è§¦å‘
        
        function checkReportLockStatus() {
            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                const reportButton = document.querySelector('[data-app="report"]');
                
                if (data.success && data.engines_ready) {
                    // æ–‡ä»¶å‡†å¤‡å°±ç»ªï¼Œè§£é”æŒ‰é’®
                    reportButton.classList.remove('locked');
                    reportButton.title = 'Report Engine - æ™ºèƒ½æŠ¥å‘Šç”Ÿæˆ\næ‰€æœ‰å¼•æ“éƒ½æœ‰æ–°æ–‡ä»¶ï¼Œå¯ä»¥ç”ŸæˆæŠ¥å‘Š';
                    
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æŠ¥å‘Šåœ¨æ˜¾ç¤º
                    const reportPreview = document.getElementById('reportPreview');
                    const hasReport = reportPreview && reportPreview.querySelector('iframe');
                    
                    // å¦‚æœå½“å‰åœ¨reporté¡µé¢ä¸”è¿˜æ²¡æœ‰è§¦å‘è‡ªåŠ¨ç”Ÿæˆä¸”æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ä¸”æ²¡æœ‰å·²æ˜¾ç¤ºçš„æŠ¥å‘Šï¼Œåˆ™è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Š
                    if (currentApp === 'report' && !autoGenerateTriggered && !reportTaskId && !hasReport) {
                        autoGenerateTriggered = true;
                        console.log('æ£€æµ‹åˆ°é”æ¶ˆå¤±ä¸”æ— ç°æœ‰æŠ¥å‘Šï¼Œè‡ªåŠ¨å¼€å§‹ç”ŸæˆæŠ¥å‘Š');
                        setTimeout(() => {
                            generateReport();
                        }, 1000); // å»¶è¿Ÿ1ç§’å¼€å§‹ç”Ÿæˆ
                    }
                } else {
                    // æ–‡ä»¶æœªå‡†å¤‡å°±ç»ªï¼Œé”å®šæŒ‰é’®
                    reportButton.classList.add('locked');
                    
                    // æ„å»ºè¯¦ç»†çš„æç¤ºä¿¡æ¯
                    let titleInfo = '\n';
                    
                    if (data.missing_files && data.missing_files.length > 0) {
                        titleInfo += 'ç­‰å¾…æ–°æ–‡ä»¶:\n' + data.missing_files.join('\n');
                    } else {
                        titleInfo += 'ç­‰å¾…ä¸‰ä¸ªAgentå·¥ä½œå®Œæ¯•';
                    }
                    
                    reportButton.title = titleInfo;
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥Report EngineçŠ¶æ€å¤±è´¥:', error);
                // å‡ºé”™æ—¶é»˜è®¤é”å®š
                const reportButton = document.querySelector('[data-app="report"]');
                reportButton.classList.add('locked');
                reportButton.title = 'Report EngineçŠ¶æ€æ£€æŸ¥å¤±è´¥';
            });
        }

        function refreshReportLog() {
            fetch('/api/report/log')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.log_lines.length > reportLogLineCount) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    
                    // åªæ·»åŠ æ–°çš„è¡Œ
                    const newLines = data.log_lines.slice(reportLogLineCount);
                    newLines.forEach(line => {
                        const div = document.createElement('div');
                        div.className = 'console-line';
                        div.textContent = line;
                        consoleOutput.appendChild(div);
                    });
                    
                    reportLogLineCount = data.log_lines.length;
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => {
                console.error('åˆ·æ–°Reportæ—¥å¿—å¤±è´¥:', error);
            });
        }

        // åŠ è½½Report Engineæ—¥å¿—
        function loadReportLog() {
            fetch('/api/report/log')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const consoleOutput = document.getElementById('consoleOutput');
                    consoleOutput.innerHTML = '<div class="console-line">[ç³»ç»Ÿ] Report Engine æ—¥å¿—ç›‘æ§å·²å¯åŠ¨</div>';
                    
                    if (data.log_lines && data.log_lines.length > 0) {
                        data.log_lines.forEach(line => {
                            const div = document.createElement('div');
                            div.className = 'console-line';
                            div.textContent = line;
                            consoleOutput.appendChild(div);
                        });
                        
                        // é‡ç½®è®¡æ•°å™¨ä»¥ç¡®ä¿åç»­æ¶ˆæ¯èƒ½æ­£ç¡®æ˜¾ç¤º
                        reportLogLineCount = data.log_lines.length;
                    } else {
                        // å¦‚æœæ²¡æœ‰æ—¥å¿—ï¼Œé‡ç½®è®¡æ•°å™¨
                        reportLogLineCount = 0;
                    }
                    
                    consoleOutput.scrollTop = consoleOutput.scrollHeight;
                }
            })
            .catch(error => {
                console.error('åŠ è½½Reportæ—¥å¿—å¤±è´¥:', error);
            });
        }

        // è§£æè®ºå›æ¶ˆæ¯å¹¶æ·»åŠ åˆ°å¯¹è¯åŒº
        function parseForumMessage(logLine) {
            try {
                // è§£ææ—¥å¿—è¡Œæ ¼å¼: [HH:MM:SS] [SOURCE] content
                const timeMatch = logLine.match(/^\[(\d{2}:\d{2}:\d{2})\]/);
                if (!timeMatch) return null;
                
                const timestamp = timeMatch[1];
                const restContent = logLine.substring(timeMatch[0].length).trim();
                
                // è§£ææºæ ‡ç­¾
                const sourceMatch = restContent.match(/^\[([^\]]+)\]\s*(.*)$/);
                if (!sourceMatch) return null;
                
                const source = sourceMatch[1];
                const content = sourceMatch[2];
                
                // å¤„ç†å››ç§æ¶ˆæ¯ç±»å‹ï¼šä¸‰ä¸ªEngineå’ŒHOSTï¼Œè¿‡æ»¤æ‰ç³»ç»Ÿæ¶ˆæ¯å’Œç©ºå†…å®¹
                if (!['QUERY', 'INSIGHT', 'MEDIA', 'HOST'].includes(source.toUpperCase()) || 
                    !content || content.includes('=== ForumEngine')) {
                    return null;
                }
                
                // æ ¹æ®æºç±»å‹ç¡®å®šæ¶ˆæ¯ç±»å‹
                let messageType = 'agent';
                let displayName = '';
                
                switch(source.toUpperCase()) {
                    case 'INSIGHT':
                        displayName = 'Insight Engine';
                        break;
                    case 'MEDIA':
                        displayName = 'Media Engine';
                        break;
                    case 'QUERY':
                        displayName = 'Query Engine';
                        break;
                    case 'HOST':
                        messageType = 'host';
                        displayName = 'Forum Host';
                        break;
                }
                
                // å¤„ç†å†…å®¹ä¸­çš„è½¬ä¹‰å­—ç¬¦
                const displayContent = content.replace(/\\n/g, '\n').replace(/\\r/g, '');
                
                // è¿”å›è§£æåçš„æ¶ˆæ¯å¯¹è±¡
                return {
                    type: messageType,
                    source: displayName,
                    content: displayContent,
                    timestamp: timestamp
                };
                
            } catch (error) {
                console.error('è§£æè®ºå›æ¶ˆæ¯å¤±è´¥:', error);
                return null;
            }
        }

        // æ·»åŠ è®ºå›æ¶ˆæ¯åˆ°å¯¹è¯åŒº
        function addForumMessage(data) {
            const chatArea = document.getElementById('forumChatArea');
            const messageDiv = document.createElement('div');
            
            const messageType = data.type || 'system';
            messageDiv.className = `forum-message ${messageType}`;
            
            // æ ¹æ®æ¥æºæ·»åŠ ç‰¹å®šçš„CSSç±»ç”¨äºé¢œè‰²åŒºåˆ†
            if (data.source) {
                const sourceClass = data.source.toLowerCase().replace(/\s+/g, '-');
                messageDiv.classList.add(sourceClass);
                
                // æ·»åŠ å…·ä½“çš„engineç±»
                if (data.source.toLowerCase().includes('query')) {
                    messageDiv.classList.add('query-engine');
                } else if (data.source.toLowerCase().includes('insight')) {
                    messageDiv.classList.add('insight-engine');
                } else if (data.source.toLowerCase().includes('media')) {
                    messageDiv.classList.add('media-engine');
                } else if (data.source.toLowerCase().includes('host')) {
                    messageDiv.classList.add('host');
                }
            }
            
            // æ„å»ºæ¶ˆæ¯å¤´éƒ¨ï¼Œæ˜¾ç¤ºæ¥æºåç§°
            const headerText = data.sender || data.source || getMessageHeader(messageType);
            
            messageDiv.innerHTML = `
                <div class="forum-message-header">${headerText}</div>
                <div class="forum-message-content">${formatMessageContent(data.content)}</div>
                <div class="forum-timestamp">${data.timestamp || new Date().toLocaleTimeString('zh-CN')}</div>
            `;
            
            chatArea.appendChild(messageDiv);
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            if (!content) return '';
            
            // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
            return content.replace(/\n/g, '<br>');
        }

        // è·å–æ¶ˆæ¯å¤´éƒ¨
        function getMessageHeader(type) {
            switch(type) {
                case 'user': return 'ç”¨æˆ·';
                case 'agent': return 'AIåŠ©æ‰‹';
                case 'system': return 'ç³»ç»Ÿ';
                case 'host': return 'è®ºå›ä¸»æŒäºº';
                default: return 'æœªçŸ¥';
            }
        }

        // Report Engine ç›¸å…³å‡½æ•°
        let reportTaskId = null;
        let reportPollingInterval = null;

        // åŠ è½½æŠ¥å‘Šç•Œé¢
        function loadReportInterface() {
            const reportContent = document.getElementById('reportContent');
            
            // æ£€æŸ¥ReportEngineçŠ¶æ€
            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°ReportEngineçŠ¶æ€æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('status-report');
                    if (indicator) {
                        if (data.initialized) {
                            indicator.className = 'status-indicator running';
                            appStatus.report = 'running';
                        } else {
                            indicator.className = 'status-indicator';
                            appStatus.report = 'stopped';
                        }
                    }
                    
                    // æ¸²æŸ“æŠ¥å‘Šç•Œé¢
                    renderReportInterface(data);
                } else {
                    reportContent.innerHTML = `
                        <div class="report-status error">
                            <strong>é”™è¯¯:</strong> ${data.error}
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('åŠ è½½æŠ¥å‘Šç•Œé¢å¤±è´¥:', error);
                reportContent.innerHTML = `
                    <div class="report-status error">
                        <strong>åŠ è½½å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
            });
        }

        // æ¸²æŸ“æŠ¥å‘Šç•Œé¢
        function renderReportInterface(statusData) {
            const reportContent = document.getElementById('reportContent');
            
            let interfaceHTML = `
                <!-- å›ºå®šçš„çŠ¶æ€ä¿¡æ¯å— -->
                <div class="engine-status-info" id="engineStatusBlock">
                    <div class="report-status" id="engineStatusContent">
                        <div>æ­£åœ¨åˆå§‹åŒ–...</div>
                    </div>
                </div>
                
                <!-- ä»»åŠ¡è¿›åº¦åŒºåŸŸ -->
                <div id="taskProgressArea"></div>
                
                <!-- æŠ¥å‘Šé¢„è§ˆåŒºåŸŸ -->
                <div class="report-preview" id="reportPreview">
                    <div class="report-loading">
                        ç‚¹å‡»"ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š"å¼€å§‹ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š
                    </div>
                </div>
            `;
            
            reportContent.innerHTML = interfaceHTML;
            
            // ç«‹å³æ›´æ–°çŠ¶æ€ä¿¡æ¯
            updateEngineStatusDisplay(statusData);
            
            // å¦‚æœæœ‰å½“å‰ä»»åŠ¡ï¼Œæ˜¾ç¤ºä»»åŠ¡çŠ¶æ€
            if (statusData.current_task) {
                const taskArea = document.getElementById('taskProgressArea');
                if (taskArea) {
                    taskArea.innerHTML = renderTaskStatus(statusData.current_task);
                }
            }
        }

        // æ¸²æŸ“ä»»åŠ¡çŠ¶æ€ï¼ˆä½¿ç”¨æ–°çš„è¿›åº¦æ¡æ ·å¼ï¼‰
        function renderTaskStatus(task) {
            // çŠ¶æ€æ–‡æœ¬çš„ä¸­æ–‡æ˜ å°„
            const statusText = {
                'running': 'æ­£åœ¨ç”Ÿæˆ',
                'completed': 'å·²å®Œæˆ',
                'error': 'ç”Ÿæˆå¤±è´¥',
                'pending': 'ç­‰å¾…ä¸­'
            };
            
            // çŠ¶æ€å¾½ç« æ ·å¼
            const statusBadgeClass = {
                'running': 'task-status-running',
                'completed': 'task-status-completed',
                'error': 'task-status-error',
                'pending': 'task-status-running'
            };
            
            // ä¸ºè¿è¡ŒçŠ¶æ€æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            const loadingIndicator = task.status !== 'completed' && task.status !== 'error' 
                ? '<span class="report-loading-spinner"></span>' 
                : '';
            
            let statusHTML = `
                <div class="task-progress-container">
                    <div class="task-progress-header">
                        <div class="task-progress-title">
                            ${loadingIndicator}æŠ¥å‘Šç”Ÿæˆä»»åŠ¡
                        </div>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${Math.min(Math.max(task.progress || 0, 0), 100)}%"></div>
                            <div class="task-progress-text">${task.progress || 0}%</div>
                        </div>
                    </div>
                    
                    <div class="task-info-line">
                        <div class="task-info-item">
                            <span class="task-info-label">ä»»åŠ¡ID:</span>
                            <span class="task-info-value">${task.task_id}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">æŸ¥è¯¢å†…å®¹:</span>
                            <span class="task-info-value">${task.query}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">å¼€å§‹æ—¶é—´:</span>
                            <span class="task-info-value">${new Date(task.created_at).toLocaleString()}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">æ›´æ–°æ—¶é—´:</span>
                            <span class="task-info-value">${new Date(task.updated_at).toLocaleString()}</span>
                        </div>
                    </div>
            `;
            
            if (task.error_message) {
                statusHTML += `
                    <div class="task-error-message">
                        <strong>é”™è¯¯ä¿¡æ¯:</strong> ${task.error_message}
                    </div>
                `;
            }
            
            statusHTML += '</div>';
            return statusHTML;
        }

        // ç”ŸæˆæŠ¥å‘Š
        function generateReport() {
            const query = document.getElementById('searchInput').value.trim() || 'æ™ºèƒ½èˆ†æƒ…åˆ†ææŠ¥å‘Š';
            
            // é‡ç½®æ—¥å¿—è®¡æ•°å™¨ï¼Œå› ä¸ºåå°ä¼šæ¸…ç©ºæ—¥å¿—æ–‡ä»¶
            reportLogLineCount = 0;
            
            // æ¸…ç©ºæ§åˆ¶å°æ˜¾ç¤º
            const consoleOutput = document.getElementById('consoleOutput');
            consoleOutput.innerHTML = '<div class="console-line">[ç³»ç»Ÿ] å¼€å§‹ç”ŸæˆæŠ¥å‘Šï¼Œæ—¥å¿—å·²é‡ç½®</div>';
            
            // æŒ‰é’®å·²ç§»é™¤ï¼Œæ— éœ€æ“ä½œæŒ‰é’®çŠ¶æ€
            
            // åœ¨ç°æœ‰çŠ¶æ€ä¿¡æ¯åæ·»åŠ ä»»åŠ¡è¿›åº¦çŠ¶æ€ï¼Œè€Œä¸æ˜¯æ›¿æ¢
            addTaskProgressStatus('æ­£åœ¨å¯åŠ¨æŠ¥å‘Šç”Ÿæˆä»»åŠ¡...', 'loading');
            
            // æ„å»ºè¯·æ±‚æ•°æ®ï¼ŒåŒ…å«è‡ªå®šä¹‰æ¨¡æ¿ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            const requestData = { query: query };
            if (customTemplate && customTemplate.trim()) {
                requestData.custom_template = customTemplate;
                console.log('ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ¿ç”ŸæˆæŠ¥å‘Š');
            }
            
            fetch('/api/report/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    reportTaskId = data.task_id;
                    showMessage('æŠ¥å‘Šç”Ÿæˆå·²å¯åŠ¨', 'success');
                    
                    // æ›´æ–°ä»»åŠ¡çŠ¶æ€æ˜¾ç¤º
                    updateTaskProgressStatus({
                        task_id: data.task_id,
                        query: query,
                        status: 'running',
                        progress: 5, // åˆå§‹è¿›åº¦è®¾ä¸º5%ï¼Œç¡®ä¿è¿›åº¦æ¡å¯è§
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });
                    
                    // ç«‹å³åˆ·æ–°ä¸€æ¬¡æ—¥å¿—ä»¥ç¡®ä¿åŒæ­¥
                    setTimeout(() => {
                        refreshReportLog();
                    }, 500);
                    
                    // å¼€å§‹è½®è¯¢ä»»åŠ¡çŠ¶æ€
                    startProgressPolling(data.task_id);
                } else {
                    updateTaskProgressStatus(null, 'error', 'å¯åŠ¨å¤±è´¥: ' + data.error);
                    // é‡ç½®æ ‡å¿—å…è®¸é‡æ–°å°è¯•
                    autoGenerateTriggered = false;
                    reportTaskId = null;
                }
            })
            .catch(error => {
                console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
                updateTaskProgressStatus(null, 'error', 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + error.message);
                // é‡ç½®æ ‡å¿—å…è®¸é‡æ–°å°è¯•
                autoGenerateTriggered = false;
                reportTaskId = null;
            });
        }

        // å¼€å§‹è¿›åº¦è½®è¯¢
        function startProgressPolling(taskId) {
            if (reportPollingInterval) {
                clearInterval(reportPollingInterval);
            }
            
            reportPollingInterval = setInterval(() => {
                checkTaskProgress(taskId);
            }, 2000);
        }

        // æ£€æŸ¥ä»»åŠ¡è¿›åº¦
        function checkTaskProgress(taskId) {
            fetch(`/api/report/progress/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProgressDisplay(data.task);
                    
                    // åœ¨æ£€æŸ¥è¿›åº¦æ—¶ä¹Ÿåˆ·æ–°æ—¥å¿—
                    refreshReportLog();
                    
                    if (data.task.status === 'completed') {
                        clearInterval(reportPollingInterval);
                        showMessage('æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼', 'success');
                        
                        // è‡ªåŠ¨æ˜¾ç¤ºæŠ¥å‘Š
                        viewReport(taskId);
                        
                        // é‡ç½®è‡ªåŠ¨ç”Ÿæˆæ ‡å¿—ï¼Œå…è®¸ä¸‹æ¬¡æœ‰æ–°å†…å®¹æ—¶è‡ªåŠ¨ç”Ÿæˆ
                        autoGenerateTriggered = false;
                        reportTaskId = null;
                    } else if (data.task.status === 'error') {
                        clearInterval(reportPollingInterval);
                        showMessage('æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + data.task.error_message, 'error');
                        
                        // é‡ç½®è‡ªåŠ¨ç”Ÿæˆæ ‡å¿—ï¼Œå…è®¸é‡æ–°å°è¯•
                        autoGenerateTriggered = false;
                        reportTaskId = null;
                    }
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥è¿›åº¦å¤±è´¥:', error);
            });
        }

        // æ·»åŠ ä»»åŠ¡è¿›åº¦çŠ¶æ€ï¼ˆä½¿ç”¨å›ºå®šåŒºåŸŸï¼‰
        function addTaskProgressStatus(message, status) {
            const taskArea = document.getElementById('taskProgressArea');
            
            if (taskArea) {
                const loadingIndicator = status === 'loading' ? '<span class="report-loading-spinner"></span>' : '';
                
                taskArea.innerHTML = `
                    <div class="task-progress-container">
                        <div class="task-progress-header">
                            ${loadingIndicator}ä»»åŠ¡çŠ¶æ€: ${message}
                        </div>
                    </div>
                `;
            }
        }
        
        // æ›´æ–°ä»»åŠ¡è¿›åº¦çŠ¶æ€ï¼ˆä½¿ç”¨å›ºå®šåŒºåŸŸï¼‰
        function updateTaskProgressStatus(task, status = null, errorMessage = null) {
            const taskArea = document.getElementById('taskProgressArea');
            
            if (!taskArea) {
                console.error('taskProgressArea not found');
                return;
            }
            
            if (task) {
                taskArea.innerHTML = renderTaskStatus(task);
            } else if (status && errorMessage) {
                const loadingIndicator = status === 'loading' ? '<span class="report-loading-spinner"></span>' : '';
                const statusBadgeClass = status === 'error' ? 'task-status-error' : 'task-status-running';
                const statusText = status === 'error' ? 'é”™è¯¯' : 'å¤„ç†ä¸­';
                
                taskArea.innerHTML = `
                    <div class="task-progress-container">
                        <div class="task-progress-header">
                            ${loadingIndicator}ä»»åŠ¡çŠ¶æ€: ${statusText}
                        </div>
                        <div style="margin-top: 10px; font-size: 14px;">
                            ${errorMessage}
                        </div>
                    </div>
                `;
            }
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤ºï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
        function updateProgressDisplay(task) {
            updateTaskProgressStatus(task);
        }

        // æŸ¥çœ‹æŠ¥å‘Š
        function viewReport(taskId) {
            const reportPreview = document.getElementById('reportPreview');
            reportPreview.innerHTML = '<div class="report-loading"><span class="report-loading-spinner"></span>åŠ è½½æŠ¥å‘Šä¸­...</div>';
            
            fetch(`/api/report/result/${taskId}`)
            .then(response => {
                if (response.ok) {
                    return response.text();
                } else {
                    throw new Error('æŠ¥å‘ŠåŠ è½½å¤±è´¥');
                }
            })
            .then(rawContent => {
                let htmlContent = rawContent;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼çš„å“åº”ï¼ˆåŒ…å«html_contentå­—æ®µï¼‰
                try {
                    if (rawContent.includes('"html_content":')) {
                        // æå–JSONä¸­çš„html_content
                        const jsonMatch = rawContent.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const jsonData = JSON.parse(jsonMatch[0]);
                            if (jsonData.html_content) {
                                htmlContent = jsonData.html_content;
                                // å¤„ç†è½¬ä¹‰å­—ç¬¦
                                htmlContent = htmlContent.replace(/\\"/g, '"').replace(/\\n/g, '\n');
                            }
                        }
                    }
                } catch (e) {
                    console.warn('è§£æJSONæ ¼å¼æŠ¥å‘Šå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å†…å®¹:', e);
                }
                
                // åˆ›å»ºiframeæ¥æ˜¾ç¤ºHTMLå†…å®¹
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.border = 'none';
                iframe.style.minHeight = '800px'; // å¢åŠ æœ€å°é«˜åº¦
                iframe.style.overflow = 'hidden'; // å¼ºåˆ¶ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡
                iframe.style.scrollbarWidth = 'none'; // Firefox
                iframe.style.msOverflowStyle = 'none'; // IE and Edge
                iframe.scrolling = 'no'; // ä¼ ç»Ÿæ–¹å¼ç¦ç”¨æ»šåŠ¨
                iframe.id = 'report-iframe';
                
                reportPreview.innerHTML = '';
                reportPreview.appendChild(iframe);
                
                // å°†HTMLå†…å®¹å†™å…¥iframe
                iframe.contentDocument.open();
                iframe.contentDocument.write(htmlContent);
                iframe.contentDocument.close();
                
                // ç¡®ä¿iframeå†…éƒ¨æ–‡æ¡£ä¹Ÿä¸æ˜¾ç¤ºæ»šåŠ¨æ¡
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                if (iframeDoc) {
                    // è®¾ç½®bodyæ ·å¼
                    if (iframeDoc.body) {
                        iframeDoc.body.style.overflow = 'hidden';
                        iframeDoc.body.style.scrollbarWidth = 'none';
                        iframeDoc.body.style.msOverflowStyle = 'none';
                    }
                    // è®¾ç½®htmlæ ·å¼
                    if (iframeDoc.documentElement) {
                        iframeDoc.documentElement.style.overflow = 'hidden';
                        iframeDoc.documentElement.style.scrollbarWidth = 'none';
                        iframeDoc.documentElement.style.msOverflowStyle = 'none';
                    }
                    // æ·»åŠ CSSè§„åˆ™éšè—webkitæ»šåŠ¨æ¡
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                        body::-webkit-scrollbar, html::-webkit-scrollbar {
                            display: none !important;
                        }
                        body, html {
                            overflow: hidden !important;
                            scrollbar-width: none !important;
                            -ms-overflow-style: none !important;
                        }
                    `;
                    iframeDoc.head.appendChild(style);
                }
                
                // ç­‰å¾…å†…å®¹åŠ è½½å®Œæˆåè°ƒæ•´iframeé«˜åº¦
                iframe.onload = function() {
                    setTimeout(() => {
                        try {
                            // è·å–iframeå†…å®¹çš„å®é™…é«˜åº¦
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            
                            // ç­‰å¾…æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆ
                            let contentHeight = 0;
                            
                            // å°è¯•å¤šç§æ–¹å¼è·å–å†…å®¹é«˜åº¦
                            if (iframeDoc.body) {
                                contentHeight = Math.max(
                                    iframeDoc.body.scrollHeight || 0,
                                    iframeDoc.body.offsetHeight || 0,
                                    iframeDoc.body.clientHeight || 0
                                );
                            }
                            
                            if (iframeDoc.documentElement) {
                                contentHeight = Math.max(
                                    contentHeight,
                                    iframeDoc.documentElement.scrollHeight || 0,
                                    iframeDoc.documentElement.offsetHeight || 0,
                                    iframeDoc.documentElement.clientHeight || 0
                                );
                            }
                            
                            // è®¾ç½®iframeé«˜åº¦ä¸ºå†…å®¹é«˜åº¦ï¼Œæœ€å°800px
                            const finalHeight = Math.max(contentHeight + 100, 800); // æ·»åŠ 100pxçš„ç¼“å†²
                            iframe.style.height = finalHeight + 'px';
                            
                            console.log(`æŠ¥å‘Šiframeé«˜åº¦å·²è°ƒæ•´ä¸º: ${finalHeight}px (å†…å®¹é«˜åº¦: ${contentHeight}px)`);
                            
                            // ç¡®ä¿çˆ¶å®¹å™¨ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
                            reportPreview.style.minHeight = finalHeight + 'px';
                            
                        } catch (error) {
                            console.error('è°ƒæ•´iframeé«˜åº¦å¤±è´¥:', error);
                            // å¦‚æœè°ƒæ•´å¤±è´¥ï¼Œä½¿ç”¨æ›´å¤§çš„é»˜è®¤é«˜åº¦
                            iframe.style.height = '1200px';
                            reportPreview.style.minHeight = '1200px';
                        }
                    }, 1000); // å»¶è¿Ÿ1ç§’ç­‰å¾…å†…å®¹å®Œå…¨æ¸²æŸ“
                };
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœonloadæ²¡æœ‰è§¦å‘ï¼Œå»¶è¿Ÿè°ƒæ•´é«˜åº¦
                setTimeout(() => {
                    if (iframe.style.height === 'auto' || iframe.style.height === '') {
                        iframe.style.height = '1200px';
                        reportPreview.style.minHeight = '1200px';
                        console.log('ä½¿ç”¨å¤‡ç”¨é«˜åº¦è®¾ç½®: 1200px');
                    }
                }, 3000);
            })
            .catch(error => {
                console.error('æŸ¥çœ‹æŠ¥å‘Šå¤±è´¥:', error);
                reportPreview.innerHTML = `
                    <div class="report-loading">
                        æŠ¥å‘ŠåŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            });
        }

        // æ£€æŸ¥æŠ¥å‘ŠçŠ¶æ€ï¼ˆä¸é‡æ–°åŠ è½½æ•´ä¸ªç•Œé¢ï¼‰
        function checkReportStatus() {
            // åªæ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªç•Œé¢
            fetch('/api/report/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°ReportEngineçŠ¶æ€æŒ‡ç¤ºå™¨
                    const indicator = document.getElementById('status-report');
                    if (indicator) {
                        if (data.initialized) {
                            indicator.className = 'status-indicator running';
                            appStatus.report = 'running';
                        } else {
                            indicator.className = 'status-indicator';
                            appStatus.report = 'stopped';
                        }
                    }
                    
                    // æ›´æ–°çŠ¶æ€ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    updateEngineStatusDisplay(data);
                    
                    showMessage('çŠ¶æ€æ£€æŸ¥å®Œæˆ', 'success');
                } else {
                    showMessage('çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('æ£€æŸ¥æŠ¥å‘ŠçŠ¶æ€å¤±è´¥:', error);
                showMessage('çŠ¶æ€æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            });
        }
        
        // æ›´æ–°å¼•æ“çŠ¶æ€æ˜¾ç¤ºï¼ˆåªæ›´æ–°æ–‡æœ¬å†…å®¹ï¼‰
        function updateEngineStatusDisplay(statusData) {
            const statusContent = document.getElementById('engineStatusContent');
            
            if (statusContent) {
                // ç¡®å®šçŠ¶æ€æ ·å¼
                const statusClass = statusData.initialized ? 'success' : 'error';
                
                // æ›´æ–°çŠ¶æ€ä¿¡æ¯å†…å®¹
                let statusHTML = '';
                if (statusData.initialized) {
                    statusHTML = `
                        <strong>ReportEngineçŠ¶æ€:</strong> å·²åˆå§‹åŒ–<br>
                        <strong>æ–‡ä»¶æ£€æŸ¥:</strong> ${statusData.engines_ready ? 'å‡†å¤‡å°±ç»ª' : 'æ–‡ä»¶æœªå°±ç»ª'}<br>
                        <strong>æ‰¾åˆ°æ–‡ä»¶:</strong> ${statusData.files_found ? statusData.files_found.join(', ') : 'æ— '}<br>
                        ${statusData.missing_files && statusData.missing_files.length > 0 ? 
                          `<strong>ç¼ºå¤±æ–‡ä»¶:</strong> ${statusData.missing_files.join(', ')}` : ''}
                    `;
                } else {
                    statusHTML = `<strong>ReportEngineçŠ¶æ€:</strong> æœªåˆå§‹åŒ–`;
                }
                
                // æ›´æ–°å†…å®¹å’Œæ ·å¼
                statusContent.innerHTML = statusHTML;
                statusContent.className = `report-status ${statusClass}`;
            }
        }

        // ==================== é…ç½®ç®¡ç†åŠŸèƒ½ ====================
        
        const CONFIG_STORAGE_KEY = 'weiyu_llm_config';
        
        // å¼•æ“é…ç½®æ¨¡æ¿
        const engineConfigs = {
            insight: {
                name: 'Insight Engine',
                description: 'ç§æœ‰æ•°æ®åº“æŒ–æ˜',
                defaultConfig: {
                    base_url: 'https://api.moonshot.cn/v1',
                    model_name: 'kimi-k2-0711-preview',
                    api_key: ''
                }
            },
            media: {
                name: 'Media Engine',
                description: 'å¤šæ¨¡æ€å†…å®¹åˆ†æ',
                defaultConfig: {
                    base_url: 'https://www.chataiapi.com/v1',
                    model_name: 'gemini-2.5-pro',
                    api_key: ''
                }
            },
            query: {
                name: 'Query Engine',
                description: 'ç²¾å‡†ä¿¡æ¯æœç´¢',
                defaultConfig: {
                    base_url: 'https://api.deepseek.com',
                    model_name: 'deepseek-reasoner',
                    api_key: ''
                }
            },
            report: {
                name: 'Report Engine',
                description: 'æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆ',
                defaultConfig: {
                    base_url: 'https://www.chataiapi.com/v1',
                    model_name: 'gemini-2.5-pro',
                    api_key: ''
                }
            },
            forum: {
                name: 'Forum Host',
                description: 'å¤šæ™ºèƒ½ä½“ä¸»æŒäºº',
                defaultConfig: {
                    base_url: 'https://api.siliconflow.cn/v1',
                    model_name: 'Qwen/Qwen3-235B-A22B-Instruct-2507',
                    api_key: ''
                }
            },
            keyword_optimizer: {
                name: 'Keyword Optimizer',
                description: 'SQL å…³é”®è¯ä¼˜åŒ–',
                defaultConfig: {
                    base_url: 'https://api.siliconflow.cn/v1',
                    model_name: 'Qwen/Qwen3-30B-A3B-Instruct-2507',
                    api_key: ''
                }
            }
        };
        
        // ä» localStorage åŠ è½½é…ç½®
        function loadConfigFromStorage() {
            try {
                const storedConfig = localStorage.getItem(CONFIG_STORAGE_KEY);
                if (storedConfig) {
                    return JSON.parse(storedConfig);
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
            return null;
        }
        
        // ä¿å­˜é…ç½®åˆ° localStorage
        function saveConfigToStorage(config) {
            try {
                localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(config));
                return true;
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                return false;
            }
        }
        
        // æ‰“å¼€é…ç½®æ¨¡æ€æ¡†
        function openConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.add('show');
            
            const statusDiv = document.getElementById('configStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
                statusDiv.textContent = '';
                statusDiv.innerHTML = '';
            }
            
            // æ¸²æŸ“å¼•æ“é…ç½®è¡¨å•
            renderEngineConfigForms();
            
            // åŠ è½½å½“å‰é…ç½®
            loadCurrentConfig();
        }
        
        // å…³é—­é…ç½®æ¨¡æ€æ¡†
        function closeConfigModal() {
            const modal = document.getElementById('configModal');
            modal.classList.remove('show');
        }
        
        // æ¸²æŸ“å¼•æ“é…ç½®è¡¨å•
        function renderEngineConfigForms() {
            const container = document.getElementById('engineConfigContainer');
            container.innerHTML = '';
            
            for (const [engineKey, engineInfo] of Object.entries(engineConfigs)) {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'config-group';
                groupDiv.innerHTML = `
                    <h4>${engineInfo.name} - ${engineInfo.description}</h4>
                    <div class="config-field">
                        <label for="${engineKey}_base_url">Base URL</label>
                        <input type="text" 
                               id="${engineKey}_base_url" 
                               name="${engineKey}_base_url" 
                               placeholder="${engineInfo.defaultConfig.base_url}">
                    </div>
                    <div class="config-field">
                        <label for="${engineKey}_model_name">Model Name</label>
                        <input type="text" 
                               id="${engineKey}_model_name" 
                               name="${engineKey}_model_name" 
                               placeholder="${engineInfo.defaultConfig.model_name}">
                    </div>
                    <div class="config-field">
                        <label for="${engineKey}_api_key">API Key</label>
                        <input type="password" 
                               id="${engineKey}_api_key" 
                               name="${engineKey}_api_key" 
                               placeholder="è¾“å…¥ API Key">
                        <div class="config-info">API Key ä¼šå®‰å…¨ä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°ã€‚</div>
                    </div>
                `;
                container.appendChild(groupDiv);
            }
        }
        
        // åŠ è½½å½“å‰é…ç½®
        function loadCurrentConfig() {
            const storedConfig = loadConfigFromStorage();
            
            if (storedConfig) {
                // åŠ è½½å¼•æ“é…ç½®
                if (storedConfig.engines) {
                    for (const [engineKey, engineConfig] of Object.entries(storedConfig.engines)) {
                        const baseUrlInput = document.getElementById(`${engineKey}_base_url`);
                        const modelNameInput = document.getElementById(`${engineKey}_model_name`);
                        const apiKeyInput = document.getElementById(`${engineKey}_api_key`);

                        if (baseUrlInput) {
                            baseUrlInput.value = engineConfig.base_url || engineConfigs[engineKey].defaultConfig.base_url;
                        }
                        if (modelNameInput) {
                            modelNameInput.value = engineConfig.model_name || engineConfigs[engineKey].defaultConfig.model_name;
                        }
                        if (apiKeyInput && engineConfig.api_key) {
                            apiKeyInput.value = engineConfig.api_key;
                        }
                    }
                }
                
                // åŠ è½½æœç´¢å·¥å…·é…ç½®
                if (storedConfig.search_tools) {
                    if (storedConfig.search_tools.tavily_api_key) {
                        document.getElementById('tavilyApiKey').value = storedConfig.search_tools.tavily_api_key;
                    }
                    if (storedConfig.search_tools.bocha_api_key) {
                        document.getElementById('bochaApiKey').value = storedConfig.search_tools.bocha_api_key;
                    }
                }

                // åŠ è½½MindSpideré…ç½®
                if (storedConfig.mindspider && storedConfig.mindspider.deepseek_api_key) {
                    document.getElementById('mindspiderDeepseekApiKey').value = storedConfig.mindspider.deepseek_api_key;
                }

                // åŠ è½½é«˜çº§é…ç½®
                if (storedConfig.advanced) {
                    if (storedConfig.advanced.query) {
                        if (storedConfig.advanced.query.max_reflections) document.getElementById('queryMaxReflections').value = storedConfig.advanced.query.max_reflections;
                        if (storedConfig.advanced.query.max_search_results) document.getElementById('queryMaxSearchResults').value = storedConfig.advanced.query.max_search_results;
                        if (storedConfig.advanced.query.max_content_length) document.getElementById('queryMaxContentLength').value = storedConfig.advanced.query.max_content_length;
                    }
                    if (storedConfig.advanced.media) {
                        if (storedConfig.advanced.media.max_reflections) document.getElementById('mediaMaxReflections').value = storedConfig.advanced.media.max_reflections;
                        if (storedConfig.advanced.media.max_paragraphs) document.getElementById('mediaMaxParagraphs').value = storedConfig.advanced.media.max_paragraphs;
                    }
                    if (storedConfig.advanced.insight) {
                        if (storedConfig.advanced.insight.max_reflections) document.getElementById('insightMaxReflections').value = storedConfig.advanced.insight.max_reflections;
                        if (storedConfig.advanced.insight.search_hot_content_limit) document.getElementById('insightSearchHotContentLimit').value = storedConfig.advanced.insight.search_hot_content_limit;
                        if (storedConfig.advanced.insight.get_comments_limit) document.getElementById('insightGetCommentsLimit').value = storedConfig.advanced.insight.get_comments_limit;
                    }
                }

                // åŠ è½½æƒ…æ„Ÿåˆ†æé…ç½®
                if (storedConfig.sentiment) {
                    if (storedConfig.sentiment.model_type) document.getElementById('sentimentModelType').value = storedConfig.sentiment.model_type;
                    if (storedConfig.sentiment.confidence_threshold) document.getElementById('sentimentConfidenceThreshold').value = storedConfig.sentiment.confidence_threshold;
                    if (storedConfig.sentiment.batch_size) document.getElementById('sentimentBatchSize').value = storedConfig.sentiment.batch_size;
                    if (storedConfig.sentiment.max_sequence_length) document.getElementById('sentimentMaxSequenceLength').value = storedConfig.sentiment.max_sequence_length;
                }

                // åŠ è½½WebDAVé…ç½®
                if (storedConfig.webdav) {
                    if (storedConfig.webdav.url) document.getElementById('webdavUrl').value = storedConfig.webdav.url;
                    if (storedConfig.webdav.username) document.getElementById('webdavUsername').value = storedConfig.webdav.username;
                    if (storedConfig.webdav.password) document.getElementById('webdavPassword').value = storedConfig.webdav.password;
                }
            } else {
                // æ²¡æœ‰å­˜å‚¨é…ç½®æ—¶ï¼Œå¡«å……é»˜è®¤æ¨èå€¼
                for (const [engineKey, engineInfo] of Object.entries(engineConfigs)) {
                    const baseUrlInput = document.getElementById(`${engineKey}_base_url`);
                    const modelNameInput = document.getElementById(`${engineKey}_model_name`);
                    if (baseUrlInput) baseUrlInput.value = engineInfo.defaultConfig.base_url;
                    if (modelNameInput) modelNameInput.value = engineInfo.defaultConfig.model_name;
                }

                // MindSpider é»˜è®¤ä¸å¡«å†™ï¼ˆå°†è‡ªåŠ¨ç»§æ‰¿ Query Engine é…ç½®ï¼‰
                const mindspiderInput = document.getElementById('mindspiderDeepseekApiKey');
                if (mindspiderInput) {
                    mindspiderInput.value = '';
                }
            }
        }
        
        // æ¢å¤æ¨èé…ç½®
        function resetConfigToDefaults() {
            if (confirm('ç¡®å®šè¦æ¢å¤æ¨èçš„é»˜è®¤é…ç½®å—ï¼Ÿè¿™ä¸ä¼šæ¸…é™¤å·²è¾“å…¥çš„ API Keyã€‚')) {
                for (const [engineKey, engineInfo] of Object.entries(engineConfigs)) {
                    const baseUrlInput = document.getElementById(`${engineKey}_base_url`);
                    const modelNameInput = document.getElementById(`${engineKey}_model_name`);
                    if (baseUrlInput) baseUrlInput.value = engineInfo.defaultConfig.base_url;
                    if (modelNameInput) modelNameInput.value = engineInfo.defaultConfig.model_name;
                }
                const mindspiderInput = document.getElementById('mindspiderDeepseekApiKey');
                if (mindspiderInput) {
                    mindspiderInput.value = '';
                }

                // æ¢å¤é«˜çº§é…ç½®é»˜è®¤å€¼
                document.getElementById('queryMaxReflections').value = 2;
                document.getElementById('queryMaxSearchResults').value = 20;
                document.getElementById('queryMaxContentLength').value = 20000;

                document.getElementById('mediaMaxReflections').value = 2;
                document.getElementById('mediaMaxParagraphs').value = 5;

                document.getElementById('insightMaxReflections').value = 3;
                document.getElementById('insightSearchHotContentLimit').value = 100;
                document.getElementById('insightGetCommentsLimit').value = 500;

                document.getElementById('sentimentModelType').value = 'multilingual';
                document.getElementById('sentimentConfidenceThreshold').value = 0.8;
                document.getElementById('sentimentBatchSize').value = 32;
                document.getElementById('sentimentMaxSequenceLength').value = 512;

                document.getElementById('webdavUrl').value = '';
                document.getElementById('webdavUsername').value = '';
                document.getElementById('webdavPassword').value = '';

                showMessage('å·²æ¢å¤æ¨èé…ç½®', 'success');
            }
        }
        
        // å¤„ç†é…ç½®è¡¨å•æäº¤
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('configStatus');
            statusDiv.style.display = 'none';
            
            // æ”¶é›†é…ç½®æ•°æ®
            const configData = {
                engines: {},
                search_tools: {},
                mindspider: {},
                advanced: {
                    query: {},
                    media: {},
                    insight: {}
                },
                sentiment: {},
                webdav: {}
            };
            
            // æ”¶é›†å¼•æ“é…ç½®
            for (const engineKey of Object.keys(engineConfigs)) {
                const baseUrl = document.getElementById(`${engineKey}_base_url`).value.trim();
                const modelName = document.getElementById(`${engineKey}_model_name`).value.trim();
                const apiKey = document.getElementById(`${engineKey}_api_key`).value.trim();
                
                configData.engines[engineKey] = {
                    base_url: baseUrl || engineConfigs[engineKey].defaultConfig.base_url,
                    model_name: modelName || engineConfigs[engineKey].defaultConfig.model_name,
                    api_key: apiKey
                };
            }
            
            // æ”¶é›†æœç´¢å·¥å…·é…ç½®
            configData.search_tools.tavily_api_key = document.getElementById('tavilyApiKey').value.trim();
            configData.search_tools.bocha_api_key = document.getElementById('bochaApiKey').value.trim();

            // æ”¶é›†MindSpideré…ç½®
            configData.mindspider.deepseek_api_key = document.getElementById('mindspiderDeepseekApiKey').value.trim();

            // æ”¶é›†é«˜çº§é…ç½®
            configData.advanced.query.max_reflections = parseInt(document.getElementById('queryMaxReflections').value) || 2;
            configData.advanced.query.max_search_results = parseInt(document.getElementById('queryMaxSearchResults').value) || 20;
            configData.advanced.query.max_content_length = parseInt(document.getElementById('queryMaxContentLength').value) || 20000;

            configData.advanced.media.max_reflections = parseInt(document.getElementById('mediaMaxReflections').value) || 2;
            configData.advanced.media.max_paragraphs = parseInt(document.getElementById('mediaMaxParagraphs').value) || 5;

            configData.advanced.insight.max_reflections = parseInt(document.getElementById('insightMaxReflections').value) || 3;
            configData.advanced.insight.search_hot_content_limit = parseInt(document.getElementById('insightSearchHotContentLimit').value) || 100;
            configData.advanced.insight.get_comments_limit = parseInt(document.getElementById('insightGetCommentsLimit').value) || 500;

            // æ”¶é›†æƒ…æ„Ÿåˆ†æé…ç½®
            configData.sentiment.model_type = document.getElementById('sentimentModelType').value;
            configData.sentiment.confidence_threshold = parseFloat(document.getElementById('sentimentConfidenceThreshold').value) || 0.8;
            configData.sentiment.batch_size = parseInt(document.getElementById('sentimentBatchSize').value) || 32;
            configData.sentiment.max_sequence_length = parseInt(document.getElementById('sentimentMaxSequenceLength').value) || 512;

            // æ”¶é›†WebDAVé…ç½®
            configData.webdav.url = document.getElementById('webdavUrl').value.trim();
            configData.webdav.username = document.getElementById('webdavUsername').value.trim();
            configData.webdav.password = document.getElementById('webdavPassword').value.trim();
            
            // ä¿å­˜åˆ° localStorage
            if (saveConfigToStorage(configData)) {
                // å‘é€åˆ°åç«¯
                try {
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(configData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        statusDiv.className = 'config-status success';
                        const updates = Array.isArray(result.updates) ? result.updates.filter(Boolean) : [];
                        if (updates.length > 0) {
                            statusDiv.innerHTML = 'âœ“ é…ç½®ä¿å­˜æˆåŠŸï¼<br>' + updates.map(update => `â€¢ ${update}`).join('<br>');
                        } else {
                            statusDiv.textContent = 'âœ“ é…ç½®ä¿å­˜æˆåŠŸï¼é…ç½®å·²ç”Ÿæ•ˆã€‚';
                        }
                        statusDiv.style.display = 'block';
                        showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
                        
                        // 2ç§’åå…³é—­æ¨¡æ€æ¡†
                        setTimeout(() => {
                            closeConfigModal();
                        }, 2000);
                    } else {
                        throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
                    }
                } catch (error) {
                    statusDiv.className = 'config-status error';
                    statusDiv.textContent = 'âœ— ä¿å­˜å¤±è´¥: ' + error.message;
                    statusDiv.style.display = 'block';
                    showMessage('é…ç½®ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                statusDiv.className = 'config-status error';
                statusDiv.textContent = 'âœ— æ— æ³•ä¿å­˜åˆ°æµè§ˆå™¨å­˜å‚¨ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚';
                statusDiv.style.display = 'block';
            }
        });
        
        // åœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åº”ç”¨å­˜å‚¨çš„é…ç½®
        (function initializeConfig() {
            const storedConfig = loadConfigFromStorage();
            if (storedConfig) {
                fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(storedConfig)
                }).then(response => response.json())
                  .then(result => {
                      if (result.success) {
                          console.log('å·²ä»æµè§ˆå™¨å­˜å‚¨åŠ è½½é…ç½®');
                      }
                  })
                  .catch(error => {
                      console.error('è‡ªåŠ¨åŠ è½½é…ç½®å¤±è´¥:', error);
                  });
            }
        })();
        
        // å¯¼å‡ºé…ç½®åˆ°æœ¬åœ°æ–‡ä»¶
        function exportConfigToLocal() {
            const config = loadConfigFromStorage();
            if (!config) {
                showMessage('æ²¡æœ‰æ‰¾åˆ°é…ç½®', 'error');
                return;
            }

            const backup = {
                version: '1.0',
                backup_time: new Date().toISOString(),
                config: config
            };

            const jsonStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `weiyu_config_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showMessage('é…ç½®å·²å¯¼å‡º', 'success');
        }

        // ä»æœ¬åœ°æ–‡ä»¶å¯¼å…¥é…ç½®
        function importConfigFromLocal() {
            document.getElementById('configFileInput').click();
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleConfigFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.config) {
                        throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                    }

                    // ä¿å­˜é…ç½®
                    if (saveConfigToStorage(backup.config)) {
                        showMessage('é…ç½®å¯¼å…¥æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ–°é…ç½®...', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        throw new Error('ä¿å­˜é…ç½®å¤±è´¥');
                    }
                } catch (error) {
                    showMessage('å¯¼å…¥å¤±è´¥: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);

            // æ¸…é™¤æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤é€‰æ‹©ç›¸åŒæ–‡ä»¶
            event.target.value = '';
        }

        // å¤‡ä»½åˆ°WebDAV
        async function backupToWebDAV() {
            const config = loadConfigFromStorage();
            if (!config) {
                showMessage('æ²¡æœ‰æ‰¾åˆ°é…ç½®', 'error');
                return;
            }

            const webdavUrl = document.getElementById('webdavUrl').value.trim();
            const webdavUsername = document.getElementById('webdavUsername').value.trim();
            const webdavPassword = document.getElementById('webdavPassword').value.trim();

            if (!webdavUrl || !webdavUsername || !webdavPassword) {
                showMessage('è¯·å…ˆå¡«å†™å®Œæ•´çš„WebDAVé…ç½®ä¿¡æ¯', 'error');
                return;
            }

            try {
                const response = await fetch('/api/config/backup/webdav', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        config: config,
                        webdav: {
                            url: webdavUrl,
                            username: webdavUsername,
                            password: webdavPassword
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('é…ç½®å·²å¤‡ä»½åˆ°WebDAV', 'success');
                } else {
                    throw new Error(result.error || 'å¤‡ä»½å¤±è´¥');
                }
            } catch (error) {
                showMessage('WebDAVå¤‡ä»½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä»WebDAVæ¢å¤é…ç½®
        async function restoreFromWebDAV() {
            const webdavUrl = document.getElementById('webdavUrl').value.trim();
            const webdavUsername = document.getElementById('webdavUsername').value.trim();
            const webdavPassword = document.getElementById('webdavPassword').value.trim();

            if (!webdavUrl || !webdavUsername || !webdavPassword) {
                showMessage('è¯·å…ˆå¡«å†™å®Œæ•´çš„WebDAVé…ç½®ä¿¡æ¯', 'error');
                return;
            }

            try {
                // é¦–å…ˆåˆ—å‡ºå¤‡ä»½æ–‡ä»¶
                const listResponse = await fetch('/api/config/list/webdav', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        webdav: {
                            url: webdavUrl,
                            username: webdavUsername,
                            password: webdavPassword
                        }
                    })
                });

                const listResult = await listResponse.json();
                if (!listResult.success) {
                    throw new Error(listResult.error || 'æ— æ³•åˆ—å‡ºå¤‡ä»½æ–‡ä»¶');
                }

                const files = listResult.files;
                if (files.length === 0) {
                    showMessage('WebDAVä¸Šæ²¡æœ‰æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶', 'info');
                    return;
                }

                // ä½¿ç”¨æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶
                const latestFile = files[0];
                const filename = latestFile.filename;

                if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ï¼š${filename}ï¼Ÿå½“å‰é…ç½®å°†è¢«è¦†ç›–ã€‚`)) {
                    return;
                }

                // æ¢å¤é…ç½®
                const restoreResponse = await fetch('/api/config/restore/webdav', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: filename,
                        webdav: {
                            url: webdavUrl,
                            username: webdavUsername,
                            password: webdavPassword
                        }
                    })
                });

                const restoreResult = await restoreResponse.json();
                if (restoreResult.success) {
                    // ä¿å­˜æ¢å¤çš„é…ç½®
                    if (saveConfigToStorage(restoreResult.config)) {
                        showMessage('é…ç½®ä»WebDAVæ¢å¤æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ä»¥åº”ç”¨æ–°é…ç½®...', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        throw new Error('ä¿å­˜é…ç½®å¤±è´¥');
                    }
                } else {
                    throw new Error(restoreResult.error || 'æ¢å¤å¤±è´¥');
                }
            } catch (error) {
                showMessage('WebDAVæ¢å¤å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('configModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeConfigModal();
            }
        });
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('configModal');
                if (modal.classList.contains('show')) {
                    closeConfigModal();
                }
            }
        });
    </script>
</body>
</html>
